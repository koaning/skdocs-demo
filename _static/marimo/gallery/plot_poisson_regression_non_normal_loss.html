<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>plot poisson regression non normal loss</title>
    <script type="module" crossorigin src="./assets/index-CmLKiEd5.js"></script>
    <link rel="modulepreload" crossorigin href="./assets/preload-helper-DImqtvgl.js">
    <link rel="modulepreload" crossorigin href="./assets/chunk-DZLz74EQ.js">
    <link rel="modulepreload" crossorigin href="./assets/react-BcIddLXZ.js">
    <link rel="modulepreload" crossorigin href="./assets/jsx-runtime-DvsdsEjx.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CLazWf1X.js">
    <link rel="modulepreload" crossorigin href="./assets/react-dom-D6bRRS5R.js">
    <link rel="modulepreload" crossorigin href="./assets/namespace-Cw55ynVb.js">
    <link rel="modulepreload" crossorigin href="./assets/cn-CwmWKpZ_.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BiHHvE7B.js">
    <link rel="modulepreload" crossorigin href="./assets/menu-items-CE6I2UvI.js">
    <link rel="modulepreload" crossorigin href="./assets/useEventListener-g9rPKvBX.js">
    <link rel="modulepreload" crossorigin href="./assets/tslib.es6-C9vXkBtU.js">
    <link rel="modulepreload" crossorigin href="./assets/fullscreen-DoREeXhW.js">
    <link rel="modulepreload" crossorigin href="./assets/events-BGfCi1Xy.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-DT6vyuIM.js">
    <link rel="modulepreload" crossorigin href="./assets/createLucideIcon-Dz-D6iuz.js">
    <link rel="modulepreload" crossorigin href="./assets/check-CmOWIaur.js">
    <link rel="modulepreload" crossorigin href="./assets/select-DIqNYEaz.js">
    <link rel="modulepreload" crossorigin href="./assets/accordion-D8h6M7fo.js">
    <link rel="modulepreload" crossorigin href="./assets/chevron-right-kGH9aJGk.js">
    <link rel="modulepreload" crossorigin href="./assets/dropdown-menu-D3tww20d.js">
    <link rel="modulepreload" crossorigin href="./assets/tooltip-CW-4dtRh.js">
    <link rel="modulepreload" crossorigin href="./assets/Logger-BkkOJyg0.js">
    <link rel="modulepreload" crossorigin href="./assets/hotkeys-ZAWHeY7d.js">
    <link rel="modulepreload" crossorigin href="./assets/react-7g8sREeT.js">
    <link rel="modulepreload" crossorigin href="./assets/_Uint8Array-D5Z9rM2X.js">
    <link rel="modulepreload" crossorigin href="./assets/_getTag-CVRrQL_Q.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseIsEqual-BF8660ot.js">
    <link rel="modulepreload" crossorigin href="./assets/invariant-B43sqCFA.js">
    <link rel="modulepreload" crossorigin href="./assets/isArrayLikeObject-DKyJYtr8.js">
    <link rel="modulepreload" crossorigin href="./assets/merge-BgA7kxZb.js">
    <link rel="modulepreload" crossorigin href="./assets/zod-U2NFpcFA.js">
    <link rel="modulepreload" crossorigin href="./assets/utils-DLuqCLqV.js">
    <link rel="modulepreload" crossorigin href="./assets/requests-BW3DqHQI.js">
    <link rel="modulepreload" crossorigin href="./assets/once-4nUTgcVU.js">
    <link rel="modulepreload" crossorigin href="./assets/toDate-BNd9AHNi.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseSlice-B27Cqkm6.js">
    <link rel="modulepreload" crossorigin href="./assets/_arrayMap-DQI2GUNb.js">
    <link rel="modulepreload" crossorigin href="./assets/isSymbol-xTSywenE.js">
    <link rel="modulepreload" crossorigin href="./assets/toString-CBnct2wx.js">
    <link rel="modulepreload" crossorigin href="./assets/_hasUnicode-CPHpt5EV.js">
    <link rel="modulepreload" crossorigin href="./assets/upperFirst-DOlTOwhh.js">
    <link rel="modulepreload" crossorigin href="./assets/capitalize-CkrfIDeS.js">
    <link rel="modulepreload" crossorigin href="./assets/ai-model-dropdown-D-i9tuGn.js">
    <link rel="modulepreload" crossorigin href="./assets/documentation-B7z6bB-t.js">
    <link rel="modulepreload" crossorigin href="./assets/badge-Cbb7s63B.js">
    <link rel="modulepreload" crossorigin href="./assets/button-g1jf7cM6.js">
    <link rel="modulepreload" crossorigin href="./assets/use-toast-BKA5A0CC.js">
    <link rel="modulepreload" crossorigin href="./assets/constants-Cv7-oioA.js">
    <link rel="modulepreload" crossorigin href="./assets/Deferred-Mppm0cvJ.js">
    <link rel="modulepreload" crossorigin href="./assets/config-BeIk_wvs.js">
    <link rel="modulepreload" crossorigin href="./assets/uuid-4lb_EYpq.js">
    <link rel="modulepreload" crossorigin href="./assets/key-Pb6bybhb.js">
    <link rel="modulepreload" crossorigin href="./assets/connection-UyRAkvTk.js">
    <link rel="modulepreload" crossorigin href="./assets/useLifecycle-DmdhGVVs.js">
    <link rel="modulepreload" crossorigin href="./assets/useNonce-DvpkYOW9.js">
    <link rel="modulepreload" crossorigin href="./assets/useTheme-BWXNjHkw.js">
    <link rel="modulepreload" crossorigin href="./assets/createReducer-CFr1RdS2.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BNtnpgX8.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-B8v7AWk6.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Ct0a8Isf.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-AWYmVWdt.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Q2QzNScK.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BFifaB39.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-D80s9YgJ.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Nl79A0iO.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CtJ8WONl.js">
    <link rel="modulepreload" crossorigin href="./assets/stex-w1KpyykF.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseProperty-CIKnF2iY.js">
    <link rel="modulepreload" crossorigin href="./assets/toNumber-CTOPJrpu.js">
    <link rel="modulepreload" crossorigin href="./assets/now-B6JN1xKT.js">
    <link rel="modulepreload" crossorigin href="./assets/debounce-70y9MzDK.js">
    <link rel="modulepreload" crossorigin href="./assets/toInteger-Bor4StOs.js">
    <link rel="modulepreload" crossorigin href="./assets/type-CYsuWFDa.js">
    <link rel="modulepreload" crossorigin href="./assets/marked.esm-BB_RKOA5.js">
    <link rel="modulepreload" crossorigin href="./assets/main-CCaZmKLi.js">
    <link rel="modulepreload" crossorigin href="./assets/cells-BEhFXxEH.js">
    <link rel="modulepreload" crossorigin href="./assets/kbd-CrDndhyw.js">
    <link rel="modulepreload" crossorigin href="./assets/renderShortcut-Bjp5Xukk.js">
    <link rel="modulepreload" crossorigin href="./assets/useEvent-itkPNnCe.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeleteCell-CIqS2s5l.js">
    <link rel="modulepreload" crossorigin href="./assets/icons-15z_NdNZ.js">
    <link rel="modulepreload" crossorigin href="./assets/spinner-fS9J74Ro.js">
    <link rel="modulepreload" crossorigin href="./assets/datasource-CwGVmPnG.js">
    <link rel="modulepreload" crossorigin href="./assets/add-missing-import-0FwDfOhv.js">
    <link rel="modulepreload" crossorigin href="./assets/ansi_up-CAiCs1Gk.js">
    <link rel="modulepreload" crossorigin href="./assets/blob-BC4M7Onc.js">
    <link rel="modulepreload" crossorigin href="./assets/dom-Ckypy4pz.js">
    <link rel="modulepreload" crossorigin href="./assets/errors-CmwnOe1B.js">
    <link rel="modulepreload" crossorigin href="./assets/extends-B47kqttt.js">
    <link rel="modulepreload" crossorigin href="./assets/objectWithoutPropertiesLoose-ClrKK0Xi.js">
    <link rel="modulepreload" crossorigin href="./assets/esm-Bp1Lbm07.js">
    <link rel="modulepreload" crossorigin href="./assets/es-Ctpp-mTr.js">
    <link rel="modulepreload" crossorigin href="./assets/play-C5VC4Hal.js">
    <link rel="modulepreload" crossorigin href="./assets/sparkles-DLotTEZ2.js">
    <link rel="modulepreload" crossorigin href="./assets/shim-FF_l0CN4.js">
    <link rel="modulepreload" crossorigin href="./assets/add-cell-with-ai-BQY4AwHL.js">
    <link rel="modulepreload" crossorigin href="./assets/ErrorBoundary-Bj7QJPi8.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-dialog-DiIW1jDy.js">
    <link rel="modulepreload" crossorigin href="./assets/dialog-gSaRWBIN.js">
    <link rel="modulepreload" crossorigin href="./assets/useDebounce-BZnPO5jA.js">
    <link rel="modulepreload" crossorigin href="./assets/numbers-P4hvbAnW.js">
    <link rel="modulepreload" crossorigin href="./assets/context-BwP_-Md9.js">
    <link rel="modulepreload" crossorigin href="./assets/useNumberFormatter-BQOmTFFk.js">
    <link rel="modulepreload" crossorigin href="./assets/input-DGY-1Oes.js">
    <link rel="modulepreload" crossorigin href="./assets/ImperativeModal-DSAh6fUR.js">
    <link rel="modulepreload" crossorigin href="./assets/filename-dpoTdlj9.js">
    <link rel="modulepreload" crossorigin href="./assets/cell-link-D8x9Ez3U.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-D4GhiyiD.js">
    <link rel="modulepreload" crossorigin href="./assets/links-DH7hmhHO.js">
    <link rel="modulepreload" crossorigin href="./assets/state-5DtoeNLQ.js">
    <link rel="modulepreload" crossorigin href="./assets/MarimoErrorOutput-CD3rG7IK.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-BxPDuBrN.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-CGWkBrzb.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-icon-7_c6G_tO.js">
    <link rel="modulepreload" crossorigin href="./assets/RenderHTML-B398JcWn.js">
    <link rel="modulepreload" crossorigin href="./assets/emotion-is-prop-valid.esm-Tm8TdcWf.js">
    <link rel="modulepreload" crossorigin href="./assets/with-selector-ChXsBWGQ.js">
    <link rel="modulepreload" crossorigin href="./assets/JsonOutput-BU4PIFXg.js">
    <link rel="modulepreload" crossorigin href="./assets/_arrayReduce-DDpPg0Qh.js">
    <link rel="modulepreload" crossorigin href="./assets/startCase-DOk4LYuA.js">
    <link rel="modulepreload" crossorigin href="./assets/strings-CrHTFiMt.js">
    <link rel="modulepreload" crossorigin href="./assets/command-W6QvsWS0.js">
    <link rel="modulepreload" crossorigin href="./assets/popover-IOch2AIR.js">
    <link rel="modulepreload" crossorigin href="./assets/table-CMFDmrFM.js">
    <link rel="modulepreload" crossorigin href="./assets/tabs-CswUuyA0.js">
    <link rel="modulepreload" crossorigin href="./assets/useAsyncData-BB0ZlY9B.js">
    <link rel="modulepreload" crossorigin href="./assets/LazyAnyLanguageCodeMirror-CInCxHCy.js">
    <link rel="modulepreload" crossorigin href="./assets/error-banner-CHF-jGs2.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-DEWTIUVh.js">
    <link rel="modulepreload" crossorigin href="./assets/precisionRound-BLxyDkD7.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-B9-NA0ur.js">
    <link rel="modulepreload" crossorigin href="./assets/vega-loader.browser.module-B3yPAbRZ.js">
    <link rel="modulepreload" crossorigin href="./assets/loader-BcHzCbiy.js">
    <link rel="modulepreload" crossorigin href="./assets/formats-Dbfcbsil.js">
    <link rel="modulepreload" crossorigin href="./assets/en-US-D7J6fBFv.js">
    <link rel="modulepreload" crossorigin href="./assets/isValid-BxWQIw0s.js">
    <link rel="modulepreload" crossorigin href="./assets/dates-D2l0yAKQ.js">
    <link rel="modulepreload" crossorigin href="./assets/download-RtEDTktT.js">
    <link rel="modulepreload" crossorigin href="./assets/maps-duCv2i7k.js">
    <link rel="modulepreload" crossorigin href="./assets/useDateFormatter-BapFytxP.js">
    <link rel="modulepreload" crossorigin href="./assets/range-BB1DXJJn.js">
    <link rel="modulepreload" crossorigin href="./assets/list-filter-DQ2_e3bh.js">
    <link rel="modulepreload" crossorigin href="./assets/columns-BeFC1dXm.js">
    <link rel="modulepreload" crossorigin href="./assets/focus-BP3h9dJJ.js">
    <link rel="modulepreload" crossorigin href="./assets/useInstallPackage-CDwTdPy7.js">
    <link rel="modulepreload" crossorigin href="./assets/column-preview-CC6unPyM.js">
    <link rel="modulepreload" crossorigin href="./assets/useAddCell-ClSRUhA6.js">
    <link rel="modulepreload" crossorigin href="./assets/toggle-DL9DPBMc.js">
    <link rel="modulepreload" crossorigin href="./assets/useHotkey-CivJpvvx.js">
    <link rel="modulepreload" crossorigin href="./assets/globals-BGEnYYSz.js">
    <link rel="modulepreload" crossorigin href="./assets/mode-kUHLEZT6.js">
    <link rel="modulepreload" crossorigin href="./assets/share-ChWJhz87.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-I8SxGjN9.js">
    <link rel="modulepreload" crossorigin href="./assets/memoize-CAcr7Wct.js">
    <link rel="modulepreload" crossorigin href="./assets/_toKey-Di_xoXjD.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseSet-Dmzd-CnA.js">
    <link rel="modulepreload" crossorigin href="./assets/utilities.esm-Dj3BexHh.js">
    <link rel="modulepreload" crossorigin href="./assets/floating-outline-CwHsH4x8.js">
    <link rel="modulepreload" crossorigin href="./assets/eye-off-wMFrY47K.js">
    <link rel="modulepreload" crossorigin href="./assets/plus-Ckxr6pwY.js">
    <link rel="modulepreload" crossorigin href="./assets/readonly-python-code-DI18L7Ip.js">
    <link rel="modulepreload" crossorigin href="./assets/file-video-camera-D5oKA5-e.js">
    <link rel="modulepreload" crossorigin href="./assets/file-text-Ds68BFYI.js">
    <link rel="modulepreload" crossorigin href="./assets/file-BX8VjCCQ.js">
    <link rel="modulepreload" crossorigin href="./assets/types-Zo5TA9DG.js">
    <link rel="modulepreload" crossorigin href="./assets/label-CFxcdBki.js">
    <link rel="modulepreload" crossorigin href="./assets/form-mBAxBzPt.js">
    <link rel="modulepreload" crossorigin href="./assets/textarea-BcNYHZLG.js">
    <link rel="modulepreload" crossorigin href="./assets/circle-x-CPCvpiTN.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-ccw-D1hQMnx_.js">
    <link rel="modulepreload" crossorigin href="./assets/trash-2-Cex53SxB.js">
    <link rel="modulepreload" crossorigin href="./assets/form-CN-qI0dC.js">
    <link rel="modulepreload" crossorigin href="./assets/field-D-WfasXC.js">
    <link rel="modulepreload" crossorigin href="./assets/switch-C2Bk9ykO.js">
    <link rel="modulepreload" crossorigin href="./assets/useBoolean-7LAl9weo.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeepCompareMemoize-CbO9MTKn.js">
    <link rel="modulepreload" crossorigin href="./assets/types-TRUculCV.js">
    <link rel="modulepreload" crossorigin href="./assets/prop-types-ShpF60yB.js">
    <link rel="modulepreload" crossorigin href="./assets/es-W4OhtMWM.js">
    <link rel="modulepreload" crossorigin href="./assets/VisuallyHidden-BfudlHw2.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseFlatten-8yEsQJi9.js">
    <link rel="modulepreload" crossorigin href="./assets/get-BYzWDFJH.js">
    <link rel="modulepreload" crossorigin href="./assets/hasIn-WaG0qjy7.js">
    <link rel="modulepreload" crossorigin href="./assets/_basePickBy-6ZBTv_cn.js">
    <link rel="modulepreload" crossorigin href="./assets/pick-BZA77Trx.js">
    <link rel="modulepreload" crossorigin href="./assets/square-DpWGO_-7.js">
    <link rel="modulepreload" crossorigin href="./assets/chart-no-axes-column-3piSAXMi.js">
    <link rel="modulepreload" crossorigin href="./assets/download-CHejLEQn.js">
    <link rel="modulepreload" crossorigin href="./assets/globe-TqnwljOq.js">
    <link rel="modulepreload" crossorigin href="./assets/send-D9MERKWw.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-cw-CmHE3eNl.js">
    <link rel="modulepreload" crossorigin href="./assets/settings-ByREbWaw.js">
    <link rel="modulepreload" crossorigin href="./assets/square-function-B5j-8u3J.js">
    <link rel="modulepreload" crossorigin href="./assets/bundle.esm-BoludFkg.js">
    <link rel="stylesheet" crossorigin href="./assets/documentation-BvrC6Bsv.css">
    <link rel="stylesheet" crossorigin href="./assets/columns-j3zW187k.css">
    <link rel="stylesheet" crossorigin href="./assets/index-DrbV-Ps3.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="">import%20marimo%0A%0A__generated_with%20%3D%20%220.17.0%22%0Aapp%20%3D%20marimo.App()%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%0A%20%20%20%20%E2%9A%A0%EF%B8%8F%20**Note**%3A%20This%20notebook%20was%20automatically%20converted%20from%20Jupyter.%0A%20%20%20%20Some%20features%20may%20behave%20differently%20in%20marimo.%0A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%0A%20%20%20%20%23%20Poisson%20regression%20and%20non-normal%20loss%0A%0A%20%20%20%20This%20example%20illustrates%20the%20use%20of%20log-linear%20Poisson%20regression%20on%20the%0A%20%20%20%20%5BFrench%20Motor%20Third-Party%20Liability%20Claims%20dataset%5D(https%3A%2F%2Fwww.openml.org%2Fd%2F41214)%20from%20%5B1%5D_%20and%20compares%20it%20with%20a%20linear%0A%20%20%20%20model%20fitted%20with%20the%20usual%20least%20squared%20error%20and%20a%20non-linear%20GBRT%20model%0A%20%20%20%20fitted%20with%20the%20Poisson%20loss%20(and%20a%20log-link).%0A%0A%20%20%20%20A%20few%20definitions%3A%0A%0A%20%20%20%20-%20A%20**policy**%20is%20a%20contract%20between%20an%20insurance%20company%20and%20an%20individual%3A%0A%20%20%20%20%20%20the%20**policyholder**%2C%20that%20is%2C%20the%20vehicle%20driver%20in%20this%20case.%0A%0A%20%20%20%20-%20A%20**claim**%20is%20the%20request%20made%20by%20a%20policyholder%20to%20the%20insurer%20to%0A%20%20%20%20%20%20compensate%20for%20a%20loss%20covered%20by%20the%20insurance.%0A%0A%20%20%20%20-%20The%20**exposure**%20is%20the%20duration%20of%20the%20insurance%20coverage%20of%20a%20given%20policy%2C%0A%20%20%20%20%20%20in%20years.%0A%0A%20%20%20%20-%20The%20claim%20**frequency**%20is%20the%20number%20of%20claims%20divided%20by%20the%20exposure%2C%0A%20%20%20%20%20%20typically%20measured%20in%20number%20of%20claims%20per%20year.%0A%0A%20%20%20%20In%20this%20dataset%2C%20each%20sample%20corresponds%20to%20an%20insurance%20policy.%20Available%0A%20%20%20%20features%20include%20driver%20age%2C%20vehicle%20age%2C%20vehicle%20power%2C%20etc.%0A%0A%20%20%20%20Our%20goal%20is%20to%20predict%20the%20expected%20frequency%20of%20claims%20following%20car%20accidents%0A%20%20%20%20for%20a%20new%20policyholder%20given%20the%20historical%20data%20over%20a%20population%20of%0A%20%20%20%20policyholders.%0A%0A%20%20%20%20..%20%5B1%5D%20%20A.%20Noll%2C%20R.%20Salzmann%20and%20M.V.%20Wuthrich%2C%20Case%20Study%3A%20French%20Motor%0A%20%20%20%20%20%20%20%20Third-Party%20Liability%20Claims%20(November%208%2C%202018).%20%5Bdoi%3A10.2139%2Fssrn.3164764%5D(https%3A%2F%2Fdoi.org%2F10.2139%2Fssrn.3164764)%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20matplotlib.pyplot%20as%20plt%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20import%20pandas%20as%20pd%0A%20%20%20%20return%20np%2C%20pd%2C%20plt%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20The%20French%20Motor%20Third-Party%20Liability%20Claims%20dataset%0A%0A%20%20%20%20Let's%20load%20the%20motor%20claim%20dataset%20from%20OpenML%3A%0A%20%20%20%20https%3A%2F%2Fwww.openml.org%2Fd%2F41214%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20sklearn.datasets%20import%20fetch_openml%0A%0A%20%20%20%20df%20%3D%20fetch_openml(data_id%3D41214%2C%20as_frame%3DTrue).frame%0A%20%20%20%20df%0A%20%20%20%20return%20(df%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20number%20of%20claims%20(%60%60ClaimNb%60%60)%20is%20a%20positive%20integer%20that%20can%20be%20modeled%0A%20%20%20%20as%20a%20Poisson%20distribution.%20It%20is%20then%20assumed%20to%20be%20the%20number%20of%20discrete%0A%20%20%20%20events%20occurring%20with%20a%20constant%20rate%20in%20a%20given%20time%20interval%20(%60%60Exposure%60%60%2C%0A%20%20%20%20in%20units%20of%20years).%0A%0A%20%20%20%20Here%20we%20want%20to%20model%20the%20frequency%20%60%60y%20%3D%20ClaimNb%20%2F%20Exposure%60%60%20conditionally%0A%20%20%20%20on%20%60%60X%60%60%20via%20a%20(scaled)%20Poisson%20distribution%2C%20and%20use%20%60%60Exposure%60%60%20as%0A%20%20%20%20%60%60sample_weight%60%60.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df%2C%20np%2C%20plt)%3A%0A%20%20%20%20df%5B'Frequency'%5D%20%3D%20df%5B'ClaimNb'%5D%20%2F%20df%5B'Exposure'%5D%0A%20%20%20%20print('Average%20Frequency%20%3D%20%7B%7D'.format(np.average(df%5B'Frequency'%5D%2C%20weights%3Ddf%5B'Exposure'%5D)))%0A%20%20%20%20print('Fraction%20of%20exposure%20with%20zero%20claims%20%3D%20%7B0%3A.1%25%7D'.format(df.loc%5Bdf%5B'ClaimNb'%5D%20%3D%3D%200%2C%20'Exposure'%5D.sum()%20%2F%20df%5B'Exposure'%5D.sum()))%0A%20%20%20%20_fig%2C%20(ax0%2C%20ax1%2C%20ax2)%20%3D%20plt.subplots(ncols%3D3%2C%20figsize%3D(16%2C%204))%0A%20%20%20%20ax0.set_title('Number%20of%20claims')%0A%20%20%20%20_%20%3D%20df%5B'ClaimNb'%5D.hist(bins%3D30%2C%20log%3DTrue%2C%20ax%3Dax0)%0A%20%20%20%20ax1.set_title('Exposure%20in%20years')%0A%20%20%20%20_%20%3D%20df%5B'Exposure'%5D.hist(bins%3D30%2C%20log%3DTrue%2C%20ax%3Dax1)%0A%20%20%20%20ax2.set_title('Frequency%20(number%20of%20claims%20per%20year)')%0A%20%20%20%20_%20%3D%20df%5B'Frequency'%5D.hist(bins%3D30%2C%20log%3DTrue%2C%20ax%3Dax2)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20remaining%20columns%20can%20be%20used%20to%20predict%20the%20frequency%20of%20claim%20events.%0A%20%20%20%20Those%20columns%20are%20very%20heterogeneous%20with%20a%20mix%20of%20categorical%20and%20numeric%0A%20%20%20%20variables%20with%20different%20scales%2C%20possibly%20very%20unevenly%20distributed.%0A%0A%20%20%20%20In%20order%20to%20fit%20linear%20models%20with%20those%20predictors%20it%20is%20therefore%0A%20%20%20%20necessary%20to%20perform%20standard%20feature%20transformations%20as%20follows%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(np)%3A%0A%20%20%20%20from%20sklearn.compose%20import%20ColumnTransformer%0A%20%20%20%20from%20sklearn.pipeline%20import%20make_pipeline%0A%20%20%20%20from%20sklearn.preprocessing%20import%20(%0A%20%20%20%20%20%20%20%20FunctionTransformer%2C%0A%20%20%20%20%20%20%20%20KBinsDiscretizer%2C%0A%20%20%20%20%20%20%20%20OneHotEncoder%2C%0A%20%20%20%20%20%20%20%20StandardScaler%2C%0A%20%20%20%20)%0A%0A%20%20%20%20log_scale_transformer%20%3D%20make_pipeline(%0A%20%20%20%20%20%20%20%20FunctionTransformer(np.log%2C%20validate%3DFalse)%2C%20StandardScaler()%0A%20%20%20%20)%0A%0A%20%20%20%20linear_model_preprocessor%20%3D%20ColumnTransformer(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22passthrough_numeric%22%2C%20%22passthrough%22%2C%20%5B%22BonusMalus%22%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22binned_numeric%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20KBinsDiscretizer(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20n_bins%3D10%2C%20quantile_method%3D%22averaged_inverted_cdf%22%2C%20random_state%3D0%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%22VehAge%22%2C%20%22DrivAge%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22log_scaled_numeric%22%2C%20log_scale_transformer%2C%20%5B%22Density%22%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22onehot_categorical%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20OneHotEncoder()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%22VehBrand%22%2C%20%22VehPower%22%2C%20%22VehGas%22%2C%20%22Region%22%2C%20%22Area%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20remainder%3D%22drop%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20ColumnTransformer%2C%20linear_model_preprocessor%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20A%20constant%20prediction%20baseline%0A%0A%20%20%20%20It%20is%20worth%20noting%20that%20more%20than%2093%25%20of%20policyholders%20have%20zero%20claims.%20If%0A%20%20%20%20we%20were%20to%20convert%20this%20problem%20into%20a%20binary%20classification%20task%2C%20it%20would%0A%20%20%20%20be%20significantly%20imbalanced%2C%20and%20even%20a%20simplistic%20model%20that%20would%20only%0A%20%20%20%20predict%20mean%20can%20achieve%20an%20accuracy%20of%2093%25.%0A%0A%20%20%20%20To%20evaluate%20the%20pertinence%20of%20the%20used%20metrics%2C%20we%20will%20consider%20as%20a%0A%20%20%20%20baseline%20a%20%22dummy%22%20estimator%20that%20constantly%20predicts%20the%20mean%20frequency%20of%0A%20%20%20%20the%20training%20sample.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df%2C%20linear_model_preprocessor)%3A%0A%20%20%20%20from%20sklearn.dummy%20import%20DummyRegressor%0A%20%20%20%20from%20sklearn.model_selection%20import%20train_test_split%0A%20%20%20%20from%20sklearn.pipeline%20import%20Pipeline%0A%0A%20%20%20%20df_train%2C%20df_test%20%3D%20train_test_split(df%2C%20test_size%3D0.33%2C%20random_state%3D0)%0A%0A%20%20%20%20dummy%20%3D%20Pipeline(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22preprocessor%22%2C%20linear_model_preprocessor)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22regressor%22%2C%20DummyRegressor(strategy%3D%22mean%22))%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20).fit(df_train%2C%20df_train%5B%22Frequency%22%5D%2C%20regressor__sample_weight%3Ddf_train%5B%22Exposure%22%5D)%0A%20%20%20%20return%20Pipeline%2C%20df_test%2C%20df_train%2C%20dummy%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Let's%20compute%20the%20performance%20of%20this%20constant%20prediction%20baseline%20with%203%0A%20%20%20%20different%20regression%20metrics%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df_test%2C%20dummy)%3A%0A%20%20%20%20from%20sklearn.metrics%20import%20mean_absolute_error%2C%20mean_poisson_deviance%2C%20mean_squared_error%0A%0A%20%20%20%20def%20score_estimator(estimator%2C%20df_test)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Score%20an%20estimator%20on%20the%20test%20set.%22%22%22%0A%20%20%20%20%20%20%20%20_y_pred%20%3D%20estimator.predict(df_test)%0A%20%20%20%20%20%20%20%20print('MSE%3A%20%25.3f'%20%25%20mean_squared_error(df_test%5B'Frequency'%5D%2C%20_y_pred%2C%20sample_weight%3Ddf_test%5B'Exposure'%5D))%0A%20%20%20%20%20%20%20%20print('MAE%3A%20%25.3f'%20%25%20mean_absolute_error(df_test%5B'Frequency'%5D%2C%20_y_pred%2C%20sample_weight%3Ddf_test%5B'Exposure'%5D))%0A%20%20%20%20%20%20%20%20mask%20%3D%20_y_pred%20%3E%200%0A%20%20%20%20%20%20%20%20if%20(~mask).any()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20n_masked%2C%20n_samples%20%3D%20((~mask).sum()%2C%20mask.shape%5B0%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f'WARNING%3A%20Estimator%20yields%20invalid%2C%20non-positive%20predictions%20%20for%20%7Bn_masked%7D%20samples%20out%20of%20%7Bn_samples%7D.%20These%20predictions%20are%20ignored%20when%20computing%20the%20Poisson%20deviance.')%0A%20%20%20%20%20%20%20%20print('mean%20Poisson%20deviance%3A%20%25.3f'%20%25%20mean_poisson_deviance(df_test%5B'Frequency'%5D%5Bmask%5D%2C%20_y_pred%5Bmask%5D%2C%20sample_weight%3Ddf_test%5B'Exposure'%5D%5Bmask%5D))%0A%20%20%20%20print('Constant%20mean%20frequency%20evaluation%3A')%0A%20%20%20%20score_estimator(dummy%2C%20df_test)%20%20%23%20Ignore%20non-positive%20predictions%2C%20as%20they%20are%20invalid%20for%20%20%23%20the%20Poisson%20deviance.%0A%20%20%20%20return%20(score_estimator%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20(Generalized)%20linear%20models%0A%0A%20%20%20%20We%20start%20by%20modeling%20the%20target%20variable%20with%20the%20(l2%20penalized)%20least%0A%20%20%20%20squares%20linear%20regression%20model%2C%20more%20commonly%20known%20as%20Ridge%20regression.%20We%0A%20%20%20%20use%20a%20low%20penalization%20%60alpha%60%2C%20as%20we%20expect%20such%20a%20linear%20model%20to%20under-fit%0A%20%20%20%20on%20such%20a%20large%20dataset.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Pipeline%2C%20df_train%2C%20linear_model_preprocessor)%3A%0A%20%20%20%20from%20sklearn.linear_model%20import%20Ridge%0A%0A%20%20%20%20ridge_glm%20%3D%20Pipeline(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22preprocessor%22%2C%20linear_model_preprocessor)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22regressor%22%2C%20Ridge(alpha%3D1e-6))%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20).fit(df_train%2C%20df_train%5B%22Frequency%22%5D%2C%20regressor__sample_weight%3Ddf_train%5B%22Exposure%22%5D)%0A%20%20%20%20return%20(ridge_glm%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20Poisson%20deviance%20cannot%20be%20computed%20on%20non-positive%20values%20predicted%20by%0A%20%20%20%20the%20model.%20For%20models%20that%20do%20return%20a%20few%20non-positive%20predictions%20(e.g.%0A%20%20%20%20%3Aclass%3A%60~sklearn.linear_model.Ridge%60)%20we%20ignore%20the%20corresponding%20samples%2C%0A%20%20%20%20meaning%20that%20the%20obtained%20Poisson%20deviance%20is%20approximate.%20An%20alternative%0A%20%20%20%20approach%20could%20be%20to%20use%20%3Aclass%3A%60~sklearn.compose.TransformedTargetRegressor%60%0A%20%20%20%20meta-estimator%20to%20map%20%60%60y_pred%60%60%20to%20a%20strictly%20positive%20domain.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df_test%2C%20ridge_glm%2C%20score_estimator)%3A%0A%20%20%20%20print(%22Ridge%20evaluation%3A%22)%0A%20%20%20%20score_estimator(ridge_glm%2C%20df_test)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Next%20we%20fit%20the%20Poisson%20regressor%20on%20the%20target%20variable.%20We%20set%20the%0A%20%20%20%20regularization%20strength%20%60%60alpha%60%60%20to%20approximately%201e-6%20over%20number%20of%0A%20%20%20%20samples%20(i.e.%20%601e-12%60)%20in%20order%20to%20mimic%20the%20Ridge%20regressor%20whose%20L2%20penalty%0A%20%20%20%20term%20scales%20differently%20with%20the%20number%20of%20samples.%0A%0A%20%20%20%20Since%20the%20Poisson%20regressor%20internally%20models%20the%20log%20of%20the%20expected%20target%0A%20%20%20%20value%20instead%20of%20the%20expected%20value%20directly%20(log%20vs%20identity%20link%20function)%2C%0A%20%20%20%20the%20relationship%20between%20X%20and%20y%20is%20not%20exactly%20linear%20anymore.%20Therefore%20the%0A%20%20%20%20Poisson%20regressor%20is%20called%20a%20Generalized%20Linear%20Model%20(GLM)%20rather%20than%20a%0A%20%20%20%20vanilla%20linear%20model%20as%20is%20the%20case%20for%20Ridge%20regression.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(Pipeline%2C%20df_test%2C%20df_train%2C%20linear_model_preprocessor%2C%20score_estimator)%3A%0A%20%20%20%20from%20sklearn.linear_model%20import%20PoissonRegressor%0A%0A%20%20%20%20n_samples%20%3D%20df_train.shape%5B0%5D%0A%0A%20%20%20%20poisson_glm%20%3D%20Pipeline(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22preprocessor%22%2C%20linear_model_preprocessor)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22regressor%22%2C%20PoissonRegressor(alpha%3D1e-12%2C%20solver%3D%22newton-cholesky%22))%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20poisson_glm.fit(%0A%20%20%20%20%20%20%20%20df_train%2C%20df_train%5B%22Frequency%22%5D%2C%20regressor__sample_weight%3Ddf_train%5B%22Exposure%22%5D%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22PoissonRegressor%20evaluation%3A%22)%0A%20%20%20%20score_estimator(poisson_glm%2C%20df_test)%0A%20%20%20%20return%20(poisson_glm%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Gradient%20Boosting%20Regression%20Trees%20for%20Poisson%20regression%0A%0A%20%20%20%20Finally%2C%20we%20will%20consider%20a%20non-linear%20model%2C%20namely%20Gradient%20Boosting%0A%20%20%20%20Regression%20Trees.%20Tree-based%20models%20do%20not%20require%20the%20categorical%20data%20to%20be%0A%20%20%20%20one-hot%20encoded%3A%20instead%2C%20we%20can%20encode%20each%20category%20label%20with%20an%20arbitrary%0A%20%20%20%20integer%20using%20%3Aclass%3A%60~sklearn.preprocessing.OrdinalEncoder%60.%20With%20this%0A%20%20%20%20encoding%2C%20the%20trees%20will%20treat%20the%20categorical%20features%20as%20ordered%20features%2C%0A%20%20%20%20which%20might%20not%20be%20always%20a%20desired%20behavior.%20However%20this%20effect%20is%20limited%0A%20%20%20%20for%20deep%20enough%20trees%20which%20are%20able%20to%20recover%20the%20categorical%20nature%20of%20the%0A%20%20%20%20features.%20The%20main%20advantage%20of%20the%0A%20%20%20%20%3Aclass%3A%60~sklearn.preprocessing.OrdinalEncoder%60%20over%20the%0A%20%20%20%20%3Aclass%3A%60~sklearn.preprocessing.OneHotEncoder%60%20is%20that%20it%20will%20make%20training%0A%20%20%20%20faster.%0A%0A%20%20%20%20Gradient%20Boosting%20also%20gives%20the%20possibility%20to%20fit%20the%20trees%20with%20a%20Poisson%0A%20%20%20%20loss%20(with%20an%20implicit%20log-link%20function)%20instead%20of%20the%20default%0A%20%20%20%20least-squares%20loss.%20Here%20we%20only%20fit%20trees%20with%20the%20Poisson%20loss%20to%20keep%20this%0A%20%20%20%20example%20concise.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ColumnTransformer%2C%20Pipeline%2C%20df_test%2C%20df_train%2C%20score_estimator)%3A%0A%20%20%20%20from%20sklearn.ensemble%20import%20HistGradientBoostingRegressor%0A%20%20%20%20from%20sklearn.preprocessing%20import%20OrdinalEncoder%0A%0A%20%20%20%20tree_preprocessor%20%3D%20ColumnTransformer(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22categorical%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20OrdinalEncoder()%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5B%22VehBrand%22%2C%20%22VehPower%22%2C%20%22VehGas%22%2C%20%22Region%22%2C%20%22Area%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22numeric%22%2C%20%22passthrough%22%2C%20%5B%22VehAge%22%2C%20%22DrivAge%22%2C%20%22BonusMalus%22%2C%20%22Density%22%5D)%2C%0A%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20remainder%3D%22drop%22%2C%0A%20%20%20%20)%0A%20%20%20%20poisson_gbrt%20%3D%20Pipeline(%0A%20%20%20%20%20%20%20%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(%22preprocessor%22%2C%20tree_preprocessor)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22regressor%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20HistGradientBoostingRegressor(loss%3D%22poisson%22%2C%20max_leaf_nodes%3D128)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%5D%0A%20%20%20%20)%0A%20%20%20%20poisson_gbrt.fit(%0A%20%20%20%20%20%20%20%20df_train%2C%20df_train%5B%22Frequency%22%5D%2C%20regressor__sample_weight%3Ddf_train%5B%22Exposure%22%5D%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22Poisson%20Gradient%20Boosted%20Trees%20evaluation%3A%22)%0A%20%20%20%20score_estimator(poisson_gbrt%2C%20df_test)%0A%20%20%20%20return%20(poisson_gbrt%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Like%20the%20Poisson%20GLM%20above%2C%20the%20gradient%20boosted%20trees%20model%20minimizes%0A%20%20%20%20the%20Poisson%20deviance.%20However%2C%20because%20of%20a%20higher%20predictive%20power%2C%0A%20%20%20%20it%20reaches%20lower%20values%20of%20Poisson%20deviance.%0A%0A%20%20%20%20Evaluating%20models%20with%20a%20single%20train%20%2F%20test%20split%20is%20prone%20to%20random%0A%20%20%20%20fluctuations.%20If%20computing%20resources%20allow%2C%20it%20should%20be%20verified%20that%0A%20%20%20%20cross-validated%20performance%20metrics%20would%20lead%20to%20similar%20conclusions.%0A%0A%20%20%20%20The%20qualitative%20difference%20between%20these%20models%20can%20also%20be%20visualized%20by%0A%20%20%20%20comparing%20the%20histogram%20of%20observed%20target%20values%20with%20that%20of%20predicted%0A%20%20%20%20values%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df_test%2C%20df_train%2C%20np%2C%20pd%2C%20plt%2C%20poisson_gbrt%2C%20poisson_glm%2C%20ridge_glm)%3A%0A%20%20%20%20_fig%2C%20axes%20%3D%20plt.subplots(nrows%3D2%2C%20ncols%3D4%2C%20figsize%3D(16%2C%206)%2C%20sharey%3DTrue)%0A%20%20%20%20_fig.subplots_adjust(bottom%3D0.2)%0A%20%20%20%20n_bins%20%3D%2020%0A%20%20%20%20for%20row_idx%2C%20_label%2C%20df_1%20in%20zip(range(2)%2C%20%5B'train'%2C%20'test'%5D%2C%20%5Bdf_train%2C%20df_test%5D)%3A%0A%20%20%20%20%20%20%20%20df_1%5B'Frequency'%5D.hist(bins%3Dnp.linspace(-1%2C%2030%2C%20n_bins)%2C%20ax%3Daxes%5Brow_idx%2C%200%5D)%0A%20%20%20%20%20%20%20%20axes%5Brow_idx%2C%200%5D.set_title('Data')%0A%20%20%20%20%20%20%20%20axes%5Brow_idx%2C%200%5D.set_yscale('log')%0A%20%20%20%20%20%20%20%20axes%5Brow_idx%2C%200%5D.set_xlabel('y%20(observed%20Frequency)')%0A%20%20%20%20%20%20%20%20axes%5Brow_idx%2C%200%5D.set_ylim(%5B10.0%2C%20500000.0%5D)%0A%20%20%20%20%20%20%20%20axes%5Brow_idx%2C%200%5D.set_ylabel(_label%20%2B%20'%20samples')%0A%20%20%20%20%20%20%20%20for%20idx%2C%20_model%20in%20enumerate(%5Bridge_glm%2C%20poisson_glm%2C%20poisson_gbrt%5D)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20_y_pred%20%3D%20_model.predict(df_1)%0A%20%20%20%20%20%20%20%20%20%20%20%20pd.Series(_y_pred).hist(bins%3Dnp.linspace(-1%2C%204%2C%20n_bins)%2C%20ax%3Daxes%5Brow_idx%2C%20idx%20%2B%201%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20axes%5Brow_idx%2C%20idx%20%2B%201%5D.set(title%3D_model%5B-1%5D.__class__.__name__%2C%20yscale%3D'log'%2C%20xlabel%3D'y_pred%20(predicted%20expected%20Frequency)')%0A%20%20%20%20plt.tight_layout()%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20experimental%20data%20presents%20a%20long%20tail%20distribution%20for%20%60%60y%60%60.%20In%20all%0A%20%20%20%20models%2C%20we%20predict%20the%20expected%20frequency%20of%20a%20random%20variable%2C%20so%20we%20will%0A%20%20%20%20have%20necessarily%20fewer%20extreme%20values%20than%20for%20the%20observed%20realizations%20of%0A%20%20%20%20that%20random%20variable.%20This%20explains%20that%20the%20mode%20of%20the%20histograms%20of%20model%0A%20%20%20%20predictions%20doesn't%20necessarily%20correspond%20to%20the%20smallest%20value.%0A%20%20%20%20Additionally%2C%20the%20normal%20distribution%20used%20in%20%60%60Ridge%60%60%20has%20a%20constant%0A%20%20%20%20variance%2C%20while%20for%20the%20Poisson%20distribution%20used%20in%20%60%60PoissonRegressor%60%60%20and%0A%20%20%20%20%60%60HistGradientBoostingRegressor%60%60%2C%20the%20variance%20is%20proportional%20to%20the%0A%20%20%20%20predicted%20expected%20value.%0A%0A%20%20%20%20Thus%2C%20among%20the%20considered%20estimators%2C%20%60%60PoissonRegressor%60%60%20and%0A%20%20%20%20%60%60HistGradientBoostingRegressor%60%60%20are%20a-priori%20better%20suited%20for%20modeling%20the%0A%20%20%20%20long%20tail%20distribution%20of%20the%20non-negative%20data%20as%20compared%20to%20the%20%60%60Ridge%60%60%0A%20%20%20%20model%20which%20makes%20a%20wrong%20assumption%20on%20the%20distribution%20of%20the%20target%0A%20%20%20%20variable.%0A%0A%20%20%20%20The%20%60%60HistGradientBoostingRegressor%60%60%20estimator%20has%20the%20most%20flexibility%20and%0A%20%20%20%20is%20able%20to%20predict%20higher%20expected%20values.%0A%0A%20%20%20%20Note%20that%20we%20could%20have%20used%20the%20least%20squares%20loss%20for%20the%0A%20%20%20%20%60%60HistGradientBoostingRegressor%60%60%20model.%20This%20would%20wrongly%20assume%20a%20normal%0A%20%20%20%20distributed%20response%20variable%20as%20does%20the%20%60Ridge%60%20model%2C%20and%20possibly%0A%20%20%20%20also%20lead%20to%20slightly%20negative%20predictions.%20However%20the%20gradient%20boosted%0A%20%20%20%20trees%20would%20still%20perform%20relatively%20well%20and%20in%20particular%20better%20than%0A%20%20%20%20%60%60PoissonRegressor%60%60%20thanks%20to%20the%20flexibility%20of%20the%20trees%20combined%20with%20the%0A%20%20%20%20large%20number%20of%20training%20samples.%0A%0A%20%20%20%20%23%23%20Evaluation%20of%20the%20calibration%20of%20predictions%0A%0A%20%20%20%20To%20ensure%20that%20estimators%20yield%20reasonable%20predictions%20for%20different%0A%20%20%20%20policyholder%20types%2C%20we%20can%20bin%20test%20samples%20according%20to%20%60%60y_pred%60%60%20returned%0A%20%20%20%20by%20each%20model.%20Then%20for%20each%20bin%2C%20we%20compare%20the%20mean%20predicted%20%60%60y_pred%60%60%2C%0A%20%20%20%20with%20the%20mean%20observed%20target%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df_test%2C%20dummy%2C%20np%2C%20plt%2C%20poisson_gbrt%2C%20poisson_glm%2C%20ridge_glm)%3A%0A%20%20%20%20from%20sklearn.utils%20import%20gen_even_slices%0A%0A%20%20%20%20def%20_mean_frequency_by_risk_group(y_true%2C%20y_pred%2C%20sample_weight%3DNone%2C%20n_bins%3D100)%3A%0A%20%20%20%20%20%20%20%20%22%22%22Compare%20predictions%20and%20observations%20for%20bins%20ordered%20by%20y_pred.%0A%0A%20%20%20%20%20%20%20%20We%20order%20the%20samples%20by%20%60%60y_pred%60%60%20and%20split%20it%20in%20bins.%0A%20%20%20%20%20%20%20%20In%20each%20bin%20the%20observed%20mean%20is%20compared%20with%20the%20predicted%20mean.%0A%0A%20%20%20%20%20%20%20%20Parameters%0A%20%20%20%20%20%20%20%20----------%0A%20%20%20%20%20%20%20%20y_true%3A%20array-like%20of%20shape%20(n_samples%2C)%0A%20%20%20%20%20%20%20%20%20%20%20%20Ground%20truth%20(correct)%20target%20values.%0A%20%20%20%20%20%20%20%20y_pred%3A%20array-like%20of%20shape%20(n_samples%2C)%0A%20%20%20%20%20%20%20%20%20%20%20%20Estimated%20target%20values.%0A%20%20%20%20%20%20%20%20sample_weight%20%3A%20array-like%20of%20shape%20(n_samples%2C)%0A%20%20%20%20%20%20%20%20%20%20%20%20Sample%20weights.%0A%20%20%20%20%20%20%20%20n_bins%3A%20int%0A%20%20%20%20%20%20%20%20%20%20%20%20Number%20of%20bins%20to%20use.%0A%0A%20%20%20%20%20%20%20%20Returns%0A%20%20%20%20%20%20%20%20-------%0A%20%20%20%20%20%20%20%20bin_centers%3A%20ndarray%20of%20shape%20(n_bins%2C)%0A%20%20%20%20%20%20%20%20%20%20%20%20bin%20centers%0A%20%20%20%20%20%20%20%20y_true_bin%3A%20ndarray%20of%20shape%20(n_bins%2C)%0A%20%20%20%20%20%20%20%20%20%20%20%20average%20y_pred%20for%20each%20bin%0A%20%20%20%20%20%20%20%20y_pred_bin%3A%20ndarray%20of%20shape%20(n_bins%2C)%0A%20%20%20%20%20%20%20%20%20%20%20%20average%20y_pred%20for%20each%20bin%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20idx_sort%20%3D%20np.argsort(_y_pred)%0A%20%20%20%20%20%20%20%20bin_centers%20%3D%20np.arange(0%2C%201%2C%201%20%2F%20n_bins)%20%2B%200.5%20%2F%20n_bins%0A%20%20%20%20%20%20%20%20y_pred_bin%20%3D%20np.zeros(n_bins)%0A%20%20%20%20%20%20%20%20y_true_bin%20%3D%20np.zeros(n_bins)%0A%20%20%20%20%20%20%20%20for%20n%2C%20sl%20in%20enumerate(gen_even_slices(len(y_true)%2C%20n_bins))%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20weights%20%3D%20sample_weight%5Bidx_sort%5D%5Bsl%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20y_pred_bin%5Bn%5D%20%3D%20np.average(_y_pred%5Bidx_sort%5D%5Bsl%5D%2C%20weights%3Dweights)%0A%20%20%20%20%20%20%20%20%20%20%20%20y_true_bin%5Bn%5D%20%3D%20np.average(y_true%5Bidx_sort%5D%5Bsl%5D%2C%20weights%3Dweights)%0A%20%20%20%20%20%20%20%20return%20(bin_centers%2C%20y_true_bin%2C%20y_pred_bin)%0A%20%20%20%20print(f%22Actual%20number%20of%20claims%3A%20%7Bdf_test%5B'ClaimNb'%5D.sum()%7D%22)%0A%20%20%20%20_fig%2C%20_ax%20%3D%20plt.subplots(nrows%3D2%2C%20ncols%3D2%2C%20figsize%3D(12%2C%208))%0A%20%20%20%20plt.subplots_adjust(wspace%3D0.3)%0A%20%20%20%20for%20axi%2C%20_model%20in%20zip(_ax.ravel()%2C%20%5Bridge_glm%2C%20poisson_glm%2C%20poisson_gbrt%2C%20dummy%5D)%3A%0A%20%20%20%20%20%20%20%20_y_pred%20%3D%20_model.predict(df_test)%0A%20%20%20%20%20%20%20%20y_true%20%3D%20df_test%5B'Frequency'%5D.values%0A%20%20%20%20%20%20%20%20exposure%20%3D%20df_test%5B'Exposure'%5D.values%0A%20%20%20%20%20%20%20%20q%2C%20y_true_seg%2C%20y_pred_seg%20%3D%20_mean_frequency_by_risk_group(y_true%2C%20_y_pred%2C%20sample_weight%3Dexposure%2C%20n_bins%3D10)%0A%20%20%20%20%20%20%20%20print(f'Predicted%20number%20of%20claims%20by%20%7B_model%5B-1%5D%7D%3A%20%7Bnp.sum(_y_pred%20*%20exposure)%3A.1f%7D')%0A%20%20%20%20%20%20%20%20axi.plot(q%2C%20y_pred_seg%2C%20marker%3D'x'%2C%20linestyle%3D'--'%2C%20label%3D'predictions')%0A%20%20%20%20%20%20%20%20axi.plot(q%2C%20y_true_seg%2C%20marker%3D'o'%2C%20linestyle%3D'--'%2C%20label%3D'observations')%0A%20%20%20%20%20%20%20%20axi.set_xlim(0%2C%201.0)%0A%20%20%20%20%20%20%20%20axi.set_ylim(0%2C%200.5)%0A%20%20%20%20%20%20%20%20axi.set(title%3D_model%5B-1%5D%2C%20xlabel%3D'Fraction%20of%20samples%20sorted%20by%20y_pred'%2C%20ylabel%3D'Mean%20Frequency%20(y_pred)')%0A%20%20%20%20%20%20%20%20axi.legend()%0A%20%20%20%20plt.tight_layout()%20%20%23%20Name%20of%20the%20model%20after%20the%20estimator%20used%20in%20the%20last%20step%20of%20the%20%20%23%20pipeline.%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20dummy%20regression%20model%20predicts%20a%20constant%20frequency.%20This%20model%20does%20not%0A%20%20%20%20attribute%20the%20same%20tied%20rank%20to%20all%20samples%20but%20is%20none-the-less%20globally%0A%20%20%20%20well%20calibrated%20(to%20estimate%20the%20mean%20frequency%20of%20the%20entire%20population).%0A%0A%20%20%20%20The%20%60%60Ridge%60%60%20regression%20model%20can%20predict%20very%20low%20expected%20frequencies%20that%0A%20%20%20%20do%20not%20match%20the%20data.%20It%20can%20therefore%20severely%20under-estimate%20the%20risk%20for%0A%20%20%20%20some%20policyholders.%0A%0A%20%20%20%20%60%60PoissonRegressor%60%60%20and%20%60%60HistGradientBoostingRegressor%60%60%20show%20better%0A%20%20%20%20consistency%20between%20predicted%20and%20observed%20targets%2C%20especially%20for%20low%0A%20%20%20%20predicted%20target%20values.%0A%0A%20%20%20%20The%20sum%20of%20all%20predictions%20also%20confirms%20the%20calibration%20issue%20of%20the%0A%20%20%20%20%60%60Ridge%60%60%20model%3A%20it%20under-estimates%20by%20more%20than%203%25%20the%20total%20number%20of%0A%20%20%20%20claims%20in%20the%20test%20set%20while%20the%20other%20three%20models%20can%20approximately%20recover%0A%20%20%20%20the%20total%20number%20of%20claims%20of%20the%20test%20portfolio.%0A%0A%20%20%20%20%23%23%20Evaluation%20of%20the%20ranking%20power%0A%0A%20%20%20%20For%20some%20business%20applications%2C%20we%20are%20interested%20in%20the%20ability%20of%20the%20model%0A%20%20%20%20to%20rank%20the%20riskiest%20from%20the%20safest%20policyholders%2C%20irrespective%20of%20the%0A%20%20%20%20absolute%20value%20of%20the%20prediction.%20In%20this%20case%2C%20the%20model%20evaluation%20would%0A%20%20%20%20cast%20the%20problem%20as%20a%20ranking%20problem%20rather%20than%20a%20regression%20problem.%0A%0A%20%20%20%20To%20compare%20the%203%20models%20from%20this%20perspective%2C%20one%20can%20plot%20the%20cumulative%0A%20%20%20%20proportion%20of%20claims%20vs%20the%20cumulative%20proportion%20of%20exposure%20for%20the%20test%0A%20%20%20%20samples%20order%20by%20the%20model%20predictions%2C%20from%20safest%20to%20riskiest%20according%20to%0A%20%20%20%20each%20model.%0A%0A%20%20%20%20This%20plot%20is%20called%20a%20Lorenz%20curve%20and%20can%20be%20summarized%20by%20the%20Gini%20index%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(df_test%2C%20dummy%2C%20np%2C%20plt%2C%20poisson_gbrt%2C%20poisson_glm%2C%20ridge_glm)%3A%0A%20%20%20%20from%20sklearn.metrics%20import%20auc%0A%0A%20%20%20%20def%20lorenz_curve(y_true%2C%20y_pred%2C%20exposure)%3A%0A%20%20%20%20%20%20%20%20y_true%2C%20_y_pred%20%3D%20(np.asarray(y_true)%2C%20np.asarray(_y_pred))%0A%20%20%20%20%20%20%20%20exposure%20%3D%20np.asarray(exposure)%0A%20%20%20%20%20%20%20%20ranking%20%3D%20np.argsort(_y_pred)%0A%20%20%20%20%20%20%20%20ranked_frequencies%20%3D%20y_true%5Branking%5D%0A%20%20%20%20%20%20%20%20ranked_exposure%20%3D%20exposure%5Branking%5D%0A%20%20%20%20%20%20%20%20cumulated_claims%20%3D%20np.cumsum(ranked_frequencies%20*%20ranked_exposure)%0A%20%20%20%20%20%20%20%20cumulated_claims%20%3D%20cumulated_claims%20%2F%20cumulated_claims%5B-1%5D%0A%20%20%20%20%20%20%20%20cumulated_exposure%20%3D%20np.cumsum(ranked_exposure)%0A%20%20%20%20%20%20%20%20cumulated_exposure%20%3D%20cumulated_exposure%20%2F%20cumulated_exposure%5B-1%5D%0A%20%20%20%20%20%20%20%20return%20(cumulated_exposure%2C%20cumulated_claims)%0A%20%20%20%20_fig%2C%20_ax%20%3D%20plt.subplots(figsize%3D(8%2C%208))%0A%20%20%20%20for%20_model%20in%20%5Bdummy%2C%20ridge_glm%2C%20poisson_glm%2C%20poisson_gbrt%5D%3A%0A%20%20%20%20%20%20%20%20_y_pred%20%3D%20_model.predict(df_test)%0A%20%20%20%20%20%20%20%20cum_exposure%2C%20cum_claims%20%3D%20lorenz_curve(df_test%5B'Frequency'%5D%2C%20_y_pred%2C%20df_test%5B'Exposure'%5D)%0A%20%20%20%20%20%20%20%20gini%20%3D%201%20-%202%20*%20auc(cum_exposure%2C%20cum_claims)%0A%20%20%20%20%20%20%20%20_label%20%3D%20'%7B%7D%20(Gini%3A%20%7B%3A.2f%7D)'.format(_model%5B-1%5D%2C%20gini)%0A%20%20%20%20%20%20%20%20_ax.plot(cum_exposure%2C%20cum_claims%2C%20linestyle%3D'-'%2C%20label%3D_label)%0A%20%20%20%20cum_exposure%2C%20cum_claims%20%3D%20lorenz_curve(df_test%5B'Frequency'%5D%2C%20df_test%5B'Frequency'%5D%2C%20df_test%5B'Exposure'%5D)%0A%20%20%20%20gini%20%3D%201%20-%202%20*%20auc(cum_exposure%2C%20cum_claims)%0A%20%20%20%20_label%20%3D%20'Oracle%20(Gini%3A%20%7B%3A.2f%7D)'.format(gini)%0A%20%20%20%20_ax.plot(cum_exposure%2C%20cum_claims%2C%20linestyle%3D'-.'%2C%20color%3D'gray'%2C%20label%3D_label)%0A%20%20%20%20_ax.plot(%5B0%2C%201%5D%2C%20%5B0%2C%201%5D%2C%20linestyle%3D'--'%2C%20color%3D'black'%2C%20label%3D'Random%20baseline')%0A%20%20%20%20_ax.set(title%3D'Lorenz%20curves%20by%20model'%2C%20xlabel%3D'Cumulative%20proportion%20of%20exposure%20(from%20safest%20to%20riskiest)'%2C%20ylabel%3D'Cumulative%20proportion%20of%20claims')%0A%20%20%20%20_ax.legend(loc%3D'upper%20left')%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20As%20expected%2C%20the%20dummy%20regressor%20is%20unable%20to%20correctly%20rank%20the%20samples%20and%0A%20%20%20%20therefore%20performs%20the%20worst%20on%20this%20plot.%0A%0A%20%20%20%20The%20tree-based%20model%20is%20significantly%20better%20at%20ranking%20policyholders%20by%20risk%0A%20%20%20%20while%20the%20two%20linear%20models%20perform%20similarly.%0A%0A%20%20%20%20All%20three%20models%20are%20significantly%20better%20than%20chance%20but%20also%20very%20far%20from%0A%20%20%20%20making%20perfect%20predictions.%0A%0A%20%20%20%20This%20last%20point%20is%20expected%20due%20to%20the%20nature%20of%20the%20problem%3A%20the%20occurrence%0A%20%20%20%20of%20accidents%20is%20mostly%20dominated%20by%20circumstantial%20causes%20that%20are%20not%0A%20%20%20%20captured%20in%20the%20columns%20of%20the%20dataset%20and%20can%20indeed%20be%20considered%20as%20purely%0A%20%20%20%20random.%0A%0A%20%20%20%20The%20linear%20models%20assume%20no%20interactions%20between%20the%20input%20variables%20which%0A%20%20%20%20likely%20causes%20under-fitting.%20Inserting%20a%20polynomial%20feature%20extractor%0A%20%20%20%20(%3Afunc%3A%60~sklearn.preprocessing.PolynomialFeatures%60)%20indeed%20increases%20their%0A%20%20%20%20discrimative%20power%20by%202%20points%20of%20Gini%20index.%20In%20particular%20it%20improves%20the%0A%20%20%20%20ability%20of%20the%20models%20to%20identify%20the%20top%205%25%20riskiest%20profiles.%0A%0A%20%20%20%20%23%23%20Main%20takeaways%0A%0A%20%20%20%20-%20The%20performance%20of%20the%20models%20can%20be%20evaluated%20by%20their%20ability%20to%20yield%0A%20%20%20%20%20%20well-calibrated%20predictions%20and%20a%20good%20ranking.%0A%0A%20%20%20%20-%20The%20calibration%20of%20the%20model%20can%20be%20assessed%20by%20plotting%20the%20mean%20observed%0A%20%20%20%20%20%20value%20vs%20the%20mean%20predicted%20value%20on%20groups%20of%20test%20samples%20binned%20by%0A%20%20%20%20%20%20predicted%20risk.%0A%0A%20%20%20%20-%20The%20least%20squares%20loss%20(along%20with%20the%20implicit%20use%20of%20the%20identity%20link%0A%20%20%20%20%20%20function)%20of%20the%20Ridge%20regression%20model%20seems%20to%20cause%20this%20model%20to%20be%0A%20%20%20%20%20%20badly%20calibrated.%20In%20particular%2C%20it%20tends%20to%20underestimate%20the%20risk%20and%20can%0A%20%20%20%20%20%20even%20predict%20invalid%20negative%20frequencies.%0A%0A%20%20%20%20-%20Using%20the%20Poisson%20loss%20with%20a%20log-link%20can%20correct%20these%20problems%20and%20lead%0A%20%20%20%20%20%20to%20a%20well-calibrated%20linear%20model.%0A%0A%20%20%20%20-%20The%20Gini%20index%20reflects%20the%20ability%20of%20a%20model%20to%20rank%20predictions%0A%20%20%20%20%20%20irrespective%20of%20their%20absolute%20values%2C%20and%20therefore%20only%20assess%20their%0A%20%20%20%20%20%20ranking%20power.%0A%0A%20%20%20%20-%20Despite%20the%20improvement%20in%20calibration%2C%20the%20ranking%20power%20of%20both%20linear%0A%20%20%20%20%20%20models%20are%20comparable%20and%20well%20below%20the%20ranking%20power%20of%20the%20Gradient%0A%20%20%20%20%20%20Boosting%20Regression%20Trees.%0A%0A%20%20%20%20-%20The%20Poisson%20deviance%20computed%20as%20an%20evaluation%20metric%20reflects%20both%20the%0A%20%20%20%20%20%20calibration%20and%20the%20ranking%20power%20of%20the%20model.%20It%20also%20makes%20a%20linear%0A%20%20%20%20%20%20assumption%20on%20the%20ideal%20relationship%20between%20the%20expected%20value%20and%20the%0A%20%20%20%20%20%20variance%20of%20the%20response%20variable.%20For%20the%20sake%20of%20conciseness%20we%20did%20not%0A%20%20%20%20%20%20check%20whether%20this%20assumption%20holds.%0A%0A%20%20%20%20-%20Traditional%20regression%20metrics%20such%20as%20Mean%20Squared%20Error%20and%20Mean%20Absolute%0A%20%20%20%20%20%20Error%20are%20hard%20to%20meaningfully%20interpret%20on%20count%20values%20with%20many%20zeros.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(plt)%3A%0A%20%20%20%20plt.show()%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "notebook.py",
            "mode": "edit",
            "version": "0.17.0",
            "serverToken": "unused",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "custom_css": [], "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "columns", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "compact"},
            "view": {"showAppCode": false},
            "notebook": null,
            "session": null,
            "runtimeConfig": null,
        };
    </script>
  </body>
</html>
