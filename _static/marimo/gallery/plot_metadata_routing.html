<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>plot metadata routing</title>
    <script type="module" crossorigin src="./assets/index-CmLKiEd5.js"></script>
    <link rel="modulepreload" crossorigin href="./assets/preload-helper-DImqtvgl.js">
    <link rel="modulepreload" crossorigin href="./assets/chunk-DZLz74EQ.js">
    <link rel="modulepreload" crossorigin href="./assets/react-BcIddLXZ.js">
    <link rel="modulepreload" crossorigin href="./assets/jsx-runtime-DvsdsEjx.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CLazWf1X.js">
    <link rel="modulepreload" crossorigin href="./assets/react-dom-D6bRRS5R.js">
    <link rel="modulepreload" crossorigin href="./assets/namespace-Cw55ynVb.js">
    <link rel="modulepreload" crossorigin href="./assets/cn-CwmWKpZ_.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BiHHvE7B.js">
    <link rel="modulepreload" crossorigin href="./assets/menu-items-CE6I2UvI.js">
    <link rel="modulepreload" crossorigin href="./assets/useEventListener-g9rPKvBX.js">
    <link rel="modulepreload" crossorigin href="./assets/tslib.es6-C9vXkBtU.js">
    <link rel="modulepreload" crossorigin href="./assets/fullscreen-DoREeXhW.js">
    <link rel="modulepreload" crossorigin href="./assets/events-BGfCi1Xy.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-DT6vyuIM.js">
    <link rel="modulepreload" crossorigin href="./assets/createLucideIcon-Dz-D6iuz.js">
    <link rel="modulepreload" crossorigin href="./assets/check-CmOWIaur.js">
    <link rel="modulepreload" crossorigin href="./assets/select-DIqNYEaz.js">
    <link rel="modulepreload" crossorigin href="./assets/accordion-D8h6M7fo.js">
    <link rel="modulepreload" crossorigin href="./assets/chevron-right-kGH9aJGk.js">
    <link rel="modulepreload" crossorigin href="./assets/dropdown-menu-D3tww20d.js">
    <link rel="modulepreload" crossorigin href="./assets/tooltip-CW-4dtRh.js">
    <link rel="modulepreload" crossorigin href="./assets/Logger-BkkOJyg0.js">
    <link rel="modulepreload" crossorigin href="./assets/hotkeys-ZAWHeY7d.js">
    <link rel="modulepreload" crossorigin href="./assets/react-7g8sREeT.js">
    <link rel="modulepreload" crossorigin href="./assets/_Uint8Array-D5Z9rM2X.js">
    <link rel="modulepreload" crossorigin href="./assets/_getTag-CVRrQL_Q.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseIsEqual-BF8660ot.js">
    <link rel="modulepreload" crossorigin href="./assets/invariant-B43sqCFA.js">
    <link rel="modulepreload" crossorigin href="./assets/isArrayLikeObject-DKyJYtr8.js">
    <link rel="modulepreload" crossorigin href="./assets/merge-BgA7kxZb.js">
    <link rel="modulepreload" crossorigin href="./assets/zod-U2NFpcFA.js">
    <link rel="modulepreload" crossorigin href="./assets/utils-DLuqCLqV.js">
    <link rel="modulepreload" crossorigin href="./assets/requests-BW3DqHQI.js">
    <link rel="modulepreload" crossorigin href="./assets/once-4nUTgcVU.js">
    <link rel="modulepreload" crossorigin href="./assets/toDate-BNd9AHNi.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseSlice-B27Cqkm6.js">
    <link rel="modulepreload" crossorigin href="./assets/_arrayMap-DQI2GUNb.js">
    <link rel="modulepreload" crossorigin href="./assets/isSymbol-xTSywenE.js">
    <link rel="modulepreload" crossorigin href="./assets/toString-CBnct2wx.js">
    <link rel="modulepreload" crossorigin href="./assets/_hasUnicode-CPHpt5EV.js">
    <link rel="modulepreload" crossorigin href="./assets/upperFirst-DOlTOwhh.js">
    <link rel="modulepreload" crossorigin href="./assets/capitalize-CkrfIDeS.js">
    <link rel="modulepreload" crossorigin href="./assets/ai-model-dropdown-D-i9tuGn.js">
    <link rel="modulepreload" crossorigin href="./assets/documentation-B7z6bB-t.js">
    <link rel="modulepreload" crossorigin href="./assets/badge-Cbb7s63B.js">
    <link rel="modulepreload" crossorigin href="./assets/button-g1jf7cM6.js">
    <link rel="modulepreload" crossorigin href="./assets/use-toast-BKA5A0CC.js">
    <link rel="modulepreload" crossorigin href="./assets/constants-Cv7-oioA.js">
    <link rel="modulepreload" crossorigin href="./assets/Deferred-Mppm0cvJ.js">
    <link rel="modulepreload" crossorigin href="./assets/config-BeIk_wvs.js">
    <link rel="modulepreload" crossorigin href="./assets/uuid-4lb_EYpq.js">
    <link rel="modulepreload" crossorigin href="./assets/key-Pb6bybhb.js">
    <link rel="modulepreload" crossorigin href="./assets/connection-UyRAkvTk.js">
    <link rel="modulepreload" crossorigin href="./assets/useLifecycle-DmdhGVVs.js">
    <link rel="modulepreload" crossorigin href="./assets/useNonce-DvpkYOW9.js">
    <link rel="modulepreload" crossorigin href="./assets/useTheme-BWXNjHkw.js">
    <link rel="modulepreload" crossorigin href="./assets/createReducer-CFr1RdS2.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BNtnpgX8.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-B8v7AWk6.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Ct0a8Isf.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-AWYmVWdt.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Q2QzNScK.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-BFifaB39.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-D80s9YgJ.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-Nl79A0iO.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-CtJ8WONl.js">
    <link rel="modulepreload" crossorigin href="./assets/stex-w1KpyykF.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseProperty-CIKnF2iY.js">
    <link rel="modulepreload" crossorigin href="./assets/toNumber-CTOPJrpu.js">
    <link rel="modulepreload" crossorigin href="./assets/now-B6JN1xKT.js">
    <link rel="modulepreload" crossorigin href="./assets/debounce-70y9MzDK.js">
    <link rel="modulepreload" crossorigin href="./assets/toInteger-Bor4StOs.js">
    <link rel="modulepreload" crossorigin href="./assets/type-CYsuWFDa.js">
    <link rel="modulepreload" crossorigin href="./assets/marked.esm-BB_RKOA5.js">
    <link rel="modulepreload" crossorigin href="./assets/main-CCaZmKLi.js">
    <link rel="modulepreload" crossorigin href="./assets/cells-BEhFXxEH.js">
    <link rel="modulepreload" crossorigin href="./assets/kbd-CrDndhyw.js">
    <link rel="modulepreload" crossorigin href="./assets/renderShortcut-Bjp5Xukk.js">
    <link rel="modulepreload" crossorigin href="./assets/useEvent-itkPNnCe.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeleteCell-CIqS2s5l.js">
    <link rel="modulepreload" crossorigin href="./assets/icons-15z_NdNZ.js">
    <link rel="modulepreload" crossorigin href="./assets/spinner-fS9J74Ro.js">
    <link rel="modulepreload" crossorigin href="./assets/datasource-CwGVmPnG.js">
    <link rel="modulepreload" crossorigin href="./assets/add-missing-import-0FwDfOhv.js">
    <link rel="modulepreload" crossorigin href="./assets/ansi_up-CAiCs1Gk.js">
    <link rel="modulepreload" crossorigin href="./assets/blob-BC4M7Onc.js">
    <link rel="modulepreload" crossorigin href="./assets/dom-Ckypy4pz.js">
    <link rel="modulepreload" crossorigin href="./assets/errors-CmwnOe1B.js">
    <link rel="modulepreload" crossorigin href="./assets/extends-B47kqttt.js">
    <link rel="modulepreload" crossorigin href="./assets/objectWithoutPropertiesLoose-ClrKK0Xi.js">
    <link rel="modulepreload" crossorigin href="./assets/esm-Bp1Lbm07.js">
    <link rel="modulepreload" crossorigin href="./assets/es-Ctpp-mTr.js">
    <link rel="modulepreload" crossorigin href="./assets/play-C5VC4Hal.js">
    <link rel="modulepreload" crossorigin href="./assets/sparkles-DLotTEZ2.js">
    <link rel="modulepreload" crossorigin href="./assets/shim-FF_l0CN4.js">
    <link rel="modulepreload" crossorigin href="./assets/add-cell-with-ai-BQY4AwHL.js">
    <link rel="modulepreload" crossorigin href="./assets/ErrorBoundary-Bj7QJPi8.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-dialog-DiIW1jDy.js">
    <link rel="modulepreload" crossorigin href="./assets/dialog-gSaRWBIN.js">
    <link rel="modulepreload" crossorigin href="./assets/useDebounce-BZnPO5jA.js">
    <link rel="modulepreload" crossorigin href="./assets/numbers-P4hvbAnW.js">
    <link rel="modulepreload" crossorigin href="./assets/context-BwP_-Md9.js">
    <link rel="modulepreload" crossorigin href="./assets/useNumberFormatter-BQOmTFFk.js">
    <link rel="modulepreload" crossorigin href="./assets/input-DGY-1Oes.js">
    <link rel="modulepreload" crossorigin href="./assets/ImperativeModal-DSAh6fUR.js">
    <link rel="modulepreload" crossorigin href="./assets/filename-dpoTdlj9.js">
    <link rel="modulepreload" crossorigin href="./assets/cell-link-D8x9Ez3U.js">
    <link rel="modulepreload" crossorigin href="./assets/alert-D4GhiyiD.js">
    <link rel="modulepreload" crossorigin href="./assets/links-DH7hmhHO.js">
    <link rel="modulepreload" crossorigin href="./assets/state-5DtoeNLQ.js">
    <link rel="modulepreload" crossorigin href="./assets/MarimoErrorOutput-CD3rG7IK.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-BxPDuBrN.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-CGWkBrzb.js">
    <link rel="modulepreload" crossorigin href="./assets/copy-icon-7_c6G_tO.js">
    <link rel="modulepreload" crossorigin href="./assets/RenderHTML-B398JcWn.js">
    <link rel="modulepreload" crossorigin href="./assets/emotion-is-prop-valid.esm-Tm8TdcWf.js">
    <link rel="modulepreload" crossorigin href="./assets/with-selector-ChXsBWGQ.js">
    <link rel="modulepreload" crossorigin href="./assets/JsonOutput-BU4PIFXg.js">
    <link rel="modulepreload" crossorigin href="./assets/_arrayReduce-DDpPg0Qh.js">
    <link rel="modulepreload" crossorigin href="./assets/startCase-DOk4LYuA.js">
    <link rel="modulepreload" crossorigin href="./assets/strings-CrHTFiMt.js">
    <link rel="modulepreload" crossorigin href="./assets/command-W6QvsWS0.js">
    <link rel="modulepreload" crossorigin href="./assets/popover-IOch2AIR.js">
    <link rel="modulepreload" crossorigin href="./assets/table-CMFDmrFM.js">
    <link rel="modulepreload" crossorigin href="./assets/tabs-CswUuyA0.js">
    <link rel="modulepreload" crossorigin href="./assets/useAsyncData-BB0ZlY9B.js">
    <link rel="modulepreload" crossorigin href="./assets/LazyAnyLanguageCodeMirror-CInCxHCy.js">
    <link rel="modulepreload" crossorigin href="./assets/error-banner-CHF-jGs2.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-DEWTIUVh.js">
    <link rel="modulepreload" crossorigin href="./assets/precisionRound-BLxyDkD7.js">
    <link rel="modulepreload" crossorigin href="./assets/defaultLocale-B9-NA0ur.js">
    <link rel="modulepreload" crossorigin href="./assets/vega-loader.browser.module-B3yPAbRZ.js">
    <link rel="modulepreload" crossorigin href="./assets/loader-BcHzCbiy.js">
    <link rel="modulepreload" crossorigin href="./assets/formats-Dbfcbsil.js">
    <link rel="modulepreload" crossorigin href="./assets/en-US-D7J6fBFv.js">
    <link rel="modulepreload" crossorigin href="./assets/isValid-BxWQIw0s.js">
    <link rel="modulepreload" crossorigin href="./assets/dates-D2l0yAKQ.js">
    <link rel="modulepreload" crossorigin href="./assets/download-RtEDTktT.js">
    <link rel="modulepreload" crossorigin href="./assets/maps-duCv2i7k.js">
    <link rel="modulepreload" crossorigin href="./assets/useDateFormatter-BapFytxP.js">
    <link rel="modulepreload" crossorigin href="./assets/range-BB1DXJJn.js">
    <link rel="modulepreload" crossorigin href="./assets/list-filter-DQ2_e3bh.js">
    <link rel="modulepreload" crossorigin href="./assets/columns-BeFC1dXm.js">
    <link rel="modulepreload" crossorigin href="./assets/focus-BP3h9dJJ.js">
    <link rel="modulepreload" crossorigin href="./assets/useInstallPackage-CDwTdPy7.js">
    <link rel="modulepreload" crossorigin href="./assets/column-preview-CC6unPyM.js">
    <link rel="modulepreload" crossorigin href="./assets/useAddCell-ClSRUhA6.js">
    <link rel="modulepreload" crossorigin href="./assets/toggle-DL9DPBMc.js">
    <link rel="modulepreload" crossorigin href="./assets/useHotkey-CivJpvvx.js">
    <link rel="modulepreload" crossorigin href="./assets/globals-BGEnYYSz.js">
    <link rel="modulepreload" crossorigin href="./assets/mode-kUHLEZT6.js">
    <link rel="modulepreload" crossorigin href="./assets/share-ChWJhz87.js">
    <link rel="modulepreload" crossorigin href="./assets/dist-I8SxGjN9.js">
    <link rel="modulepreload" crossorigin href="./assets/memoize-CAcr7Wct.js">
    <link rel="modulepreload" crossorigin href="./assets/_toKey-Di_xoXjD.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseSet-Dmzd-CnA.js">
    <link rel="modulepreload" crossorigin href="./assets/utilities.esm-Dj3BexHh.js">
    <link rel="modulepreload" crossorigin href="./assets/floating-outline-CwHsH4x8.js">
    <link rel="modulepreload" crossorigin href="./assets/eye-off-wMFrY47K.js">
    <link rel="modulepreload" crossorigin href="./assets/plus-Ckxr6pwY.js">
    <link rel="modulepreload" crossorigin href="./assets/readonly-python-code-DI18L7Ip.js">
    <link rel="modulepreload" crossorigin href="./assets/file-video-camera-D5oKA5-e.js">
    <link rel="modulepreload" crossorigin href="./assets/file-text-Ds68BFYI.js">
    <link rel="modulepreload" crossorigin href="./assets/file-BX8VjCCQ.js">
    <link rel="modulepreload" crossorigin href="./assets/types-Zo5TA9DG.js">
    <link rel="modulepreload" crossorigin href="./assets/label-CFxcdBki.js">
    <link rel="modulepreload" crossorigin href="./assets/form-mBAxBzPt.js">
    <link rel="modulepreload" crossorigin href="./assets/textarea-BcNYHZLG.js">
    <link rel="modulepreload" crossorigin href="./assets/circle-x-CPCvpiTN.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-ccw-D1hQMnx_.js">
    <link rel="modulepreload" crossorigin href="./assets/trash-2-Cex53SxB.js">
    <link rel="modulepreload" crossorigin href="./assets/form-CN-qI0dC.js">
    <link rel="modulepreload" crossorigin href="./assets/field-D-WfasXC.js">
    <link rel="modulepreload" crossorigin href="./assets/switch-C2Bk9ykO.js">
    <link rel="modulepreload" crossorigin href="./assets/useBoolean-7LAl9weo.js">
    <link rel="modulepreload" crossorigin href="./assets/useDeepCompareMemoize-CbO9MTKn.js">
    <link rel="modulepreload" crossorigin href="./assets/types-TRUculCV.js">
    <link rel="modulepreload" crossorigin href="./assets/prop-types-ShpF60yB.js">
    <link rel="modulepreload" crossorigin href="./assets/es-W4OhtMWM.js">
    <link rel="modulepreload" crossorigin href="./assets/VisuallyHidden-BfudlHw2.js">
    <link rel="modulepreload" crossorigin href="./assets/_baseFlatten-8yEsQJi9.js">
    <link rel="modulepreload" crossorigin href="./assets/get-BYzWDFJH.js">
    <link rel="modulepreload" crossorigin href="./assets/hasIn-WaG0qjy7.js">
    <link rel="modulepreload" crossorigin href="./assets/_basePickBy-6ZBTv_cn.js">
    <link rel="modulepreload" crossorigin href="./assets/pick-BZA77Trx.js">
    <link rel="modulepreload" crossorigin href="./assets/square-DpWGO_-7.js">
    <link rel="modulepreload" crossorigin href="./assets/chart-no-axes-column-3piSAXMi.js">
    <link rel="modulepreload" crossorigin href="./assets/download-CHejLEQn.js">
    <link rel="modulepreload" crossorigin href="./assets/globe-TqnwljOq.js">
    <link rel="modulepreload" crossorigin href="./assets/send-D9MERKWw.js">
    <link rel="modulepreload" crossorigin href="./assets/refresh-cw-CmHE3eNl.js">
    <link rel="modulepreload" crossorigin href="./assets/settings-ByREbWaw.js">
    <link rel="modulepreload" crossorigin href="./assets/square-function-B5j-8u3J.js">
    <link rel="modulepreload" crossorigin href="./assets/bundle.esm-BoludFkg.js">
    <link rel="stylesheet" crossorigin href="./assets/documentation-BvrC6Bsv.css">
    <link rel="stylesheet" crossorigin href="./assets/columns-j3zW187k.css">
    <link rel="stylesheet" crossorigin href="./assets/index-DrbV-Ps3.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="">import%20marimo%0A%0A__generated_with%20%3D%20%220.17.0%22%0Aapp%20%3D%20marimo.App()%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%0A%20%20%20%20%23%20Metadata%20Routing%0A%0A%20%20%20%20..%20currentmodule%3A%3A%20sklearn%0A%0A%20%20%20%20This%20document%20shows%20how%20you%20can%20use%20the%20%60metadata%20routing%20mechanism%0A%20%20%20%20%3Cmetadata_routing%3E%60%20in%20scikit-learn%20to%20route%20metadata%20to%20the%20estimators%2C%0A%20%20%20%20scorers%2C%20and%20CV%20splitters%20consuming%20them.%0A%0A%20%20%20%20To%20better%20understand%20the%20following%20document%2C%20we%20need%20to%20introduce%20two%20concepts%3A%0A%20%20%20%20routers%20and%20consumers.%20A%20router%20is%20an%20object%20which%20forwards%20some%20given%20data%20and%0A%20%20%20%20metadata%20to%20other%20objects.%20In%20most%20cases%2C%20a%20router%20is%20a%20%3Aterm%3A%60meta-estimator%60%2C%0A%20%20%20%20i.e.%20an%20estimator%20which%20takes%20another%20estimator%20as%20a%20parameter.%20A%20function%20such%0A%20%20%20%20as%20%3Afunc%3A%60sklearn.model_selection.cross_validate%60%20which%20takes%20an%20estimator%20as%20a%0A%20%20%20%20parameter%20and%20forwards%20data%20and%20metadata%2C%20is%20also%20a%20router.%0A%0A%20%20%20%20A%20consumer%2C%20on%20the%20other%20hand%2C%20is%20an%20object%20which%20accepts%20and%20uses%20some%20given%0A%20%20%20%20metadata.%20For%20instance%2C%20an%20estimator%20taking%20into%20account%20%60%60sample_weight%60%60%20in%0A%20%20%20%20its%20%3Aterm%3A%60fit%60%20method%20is%20a%20consumer%20of%20%60%60sample_weight%60%60.%0A%0A%20%20%20%20It%20is%20possible%20for%20an%20object%20to%20be%20both%20a%20router%20and%20a%20consumer.%20For%20instance%2C%0A%20%20%20%20a%20meta-estimator%20may%20take%20into%20account%20%60%60sample_weight%60%60%20in%20certain%0A%20%20%20%20calculations%2C%20but%20it%20may%20also%20route%20it%20to%20the%20underlying%20estimator.%0A%0A%20%20%20%20First%20a%20few%20imports%20and%20some%20random%20data%20for%20the%20rest%20of%20the%20script.%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Authors%3A%20The%20scikit-learn%20developers%0A%20%20%20%20%23%20SPDX-License-Identifier%3A%20BSD-3-Clause%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20warnings%0A%20%20%20%20from%20pprint%20import%20pprint%0A%0A%20%20%20%20import%20numpy%20as%20np%0A%0A%20%20%20%20from%20sklearn%20import%20set_config%0A%20%20%20%20from%20sklearn.base%20import%20(%0A%20%20%20%20%20%20%20%20BaseEstimator%2C%0A%20%20%20%20%20%20%20%20ClassifierMixin%2C%0A%20%20%20%20%20%20%20%20MetaEstimatorMixin%2C%0A%20%20%20%20%20%20%20%20RegressorMixin%2C%0A%20%20%20%20%20%20%20%20TransformerMixin%2C%0A%20%20%20%20%20%20%20%20clone%2C%0A%20%20%20%20)%0A%20%20%20%20from%20sklearn.linear_model%20import%20LinearRegression%0A%20%20%20%20from%20sklearn.utils%20import%20metadata_routing%0A%20%20%20%20from%20sklearn.utils.metadata_routing%20import%20(%0A%20%20%20%20%20%20%20%20MetadataRouter%2C%0A%20%20%20%20%20%20%20%20MethodMapping%2C%0A%20%20%20%20%20%20%20%20get_routing_for_object%2C%0A%20%20%20%20%20%20%20%20process_routing%2C%0A%20%20%20%20)%0A%20%20%20%20from%20sklearn.utils.validation%20import%20check_is_fitted%0A%0A%20%20%20%20n_samples%2C%20n_features%20%3D%20100%2C%204%0A%20%20%20%20rng%20%3D%20np.random.RandomState(42)%0A%20%20%20%20X%20%3D%20rng.rand(n_samples%2C%20n_features)%0A%20%20%20%20y%20%3D%20rng.randint(0%2C%202%2C%20size%3Dn_samples)%0A%20%20%20%20my_groups%20%3D%20rng.randint(0%2C%2010%2C%20size%3Dn_samples)%0A%20%20%20%20my_weights%20%3D%20rng.rand(n_samples)%0A%20%20%20%20my_other_weights%20%3D%20rng.rand(n_samples)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20BaseEstimator%2C%0A%20%20%20%20%20%20%20%20ClassifierMixin%2C%0A%20%20%20%20%20%20%20%20LinearRegression%2C%0A%20%20%20%20%20%20%20%20MetaEstimatorMixin%2C%0A%20%20%20%20%20%20%20%20MetadataRouter%2C%0A%20%20%20%20%20%20%20%20MethodMapping%2C%0A%20%20%20%20%20%20%20%20RegressorMixin%2C%0A%20%20%20%20%20%20%20%20TransformerMixin%2C%0A%20%20%20%20%20%20%20%20X%2C%0A%20%20%20%20%20%20%20%20check_is_fitted%2C%0A%20%20%20%20%20%20%20%20clone%2C%0A%20%20%20%20%20%20%20%20get_routing_for_object%2C%0A%20%20%20%20%20%20%20%20metadata_routing%2C%0A%20%20%20%20%20%20%20%20my_groups%2C%0A%20%20%20%20%20%20%20%20my_other_weights%2C%0A%20%20%20%20%20%20%20%20my_weights%2C%0A%20%20%20%20%20%20%20%20np%2C%0A%20%20%20%20%20%20%20%20pprint%2C%0A%20%20%20%20%20%20%20%20process_routing%2C%0A%20%20%20%20%20%20%20%20set_config%2C%0A%20%20%20%20%20%20%20%20warnings%2C%0A%20%20%20%20%20%20%20%20y%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Metadata%20routing%20is%20only%20available%20if%20explicitly%20enabled%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(set_config)%3A%0A%20%20%20%20set_config(enable_metadata_routing%3DTrue)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20This%20utility%20function%20is%20a%20dummy%20to%20check%20if%20a%20metadata%20is%20passed%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.function%0Adef%20check_metadata(obj%2C%20**kwargs)%3A%0A%20%20%20%20for%20key%2C%20value%20in%20kwargs.items()%3A%0A%20%20%20%20%20%20%20%20if%20value%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22Received%20%7Bkey%7D%20of%20length%20%3D%20%7Blen(value)%7D%20in%20%7Bobj.__class__.__name__%7D.%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%7Bkey%7D%20is%20None%20in%20%7Bobj.__class__.__name__%7D.%22)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20A%20utility%20function%20to%20nicely%20print%20the%20routing%20information%20of%20an%20object%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(pprint)%3A%0A%20%20%20%20def%20print_routing(obj)%3A%0A%20%20%20%20%20%20%20%20pprint(obj.get_metadata_routing()._serialize())%0A%20%20%20%20return%20(print_routing%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Consuming%20Estimator%0A%20%20%20%20Here%20we%20demonstrate%20how%20an%20estimator%20can%20expose%20the%20required%20API%20to%20support%0A%20%20%20%20metadata%20routing%20as%20a%20consumer.%20Imagine%20a%20simple%20classifier%20accepting%0A%20%20%20%20%60%60sample_weight%60%60%20as%20a%20metadata%20on%20its%20%60%60fit%60%60%20and%20%60%60groups%60%60%20in%20its%0A%20%20%20%20%60%60predict%60%60%20method%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(BaseEstimator%2C%20ClassifierMixin%2C%20np)%3A%0A%20%20%20%20class%20ExampleClassifier(ClassifierMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20sample_weight%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20sample_weight%3Dsample_weight)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20all%20classifiers%20need%20to%20expose%20a%20classes_%20attribute%20once%20they're%20fit.%0A%20%20%20%20%20%20%20%20%20%20%20%20self.classes_%20%3D%20np.array(%5B0%2C%201%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self%0A%0A%20%20%20%20%20%20%20%20def%20predict(self%2C%20X%2C%20groups%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20groups%3Dgroups)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20return%20a%20constant%20value%20of%201%2C%20not%20a%20very%20smart%20classifier!%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20np.ones(len(X))%0A%20%20%20%20return%20(ExampleClassifier%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20above%20estimator%20now%20has%20all%20it%20needs%20to%20consume%20metadata.%20This%20is%0A%20%20%20%20accomplished%20by%20some%20magic%20done%20in%20%3Aclass%3A%60~base.BaseEstimator%60.%20There%20are%0A%20%20%20%20now%20three%20methods%20exposed%20by%20the%20above%20class%3A%20%60%60set_fit_request%60%60%2C%0A%20%20%20%20%60%60set_predict_request%60%60%2C%20and%20%60%60get_metadata_routing%60%60.%20There%20is%20also%20a%0A%20%20%20%20%60%60set_score_request%60%60%20for%20%60%60sample_weight%60%60%20which%20is%20present%20since%0A%20%20%20%20%3Aclass%3A%60~base.ClassifierMixin%60%20implements%20a%20%60%60score%60%60%20method%20accepting%0A%20%20%20%20%60%60sample_weight%60%60.%20The%20same%20applies%20to%20regressors%20which%20inherit%20from%0A%20%20%20%20%3Aclass%3A%60~base.RegressorMixin%60.%0A%0A%20%20%20%20By%20default%2C%20no%20metadata%20is%20requested%2C%20which%20we%20can%20see%20as%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20print_routing)%3A%0A%20%20%20%20print_routing(ExampleClassifier())%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20above%20output%20means%20that%20%60%60sample_weight%60%60%20and%20%60%60groups%60%60%20are%20not%0A%20%20%20%20requested%20by%20%60ExampleClassifier%60%2C%20and%20if%20a%20router%20is%20given%20those%20metadata%2C%20it%0A%20%20%20%20should%20raise%20an%20error%2C%20since%20the%20user%20has%20not%20explicitly%20set%20whether%20they%20are%0A%20%20%20%20required%20or%20not.%20The%20same%20is%20true%20for%20%60%60sample_weight%60%60%20in%20the%20%60%60score%60%60%0A%20%20%20%20method%2C%20which%20is%20inherited%20from%20%3Aclass%3A%60~base.ClassifierMixin%60.%20In%20order%20to%0A%20%20%20%20explicitly%20set%20request%20values%20for%20those%20metadata%2C%20we%20can%20use%20these%20methods%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20print_routing)%3A%0A%20%20%20%20_est%20%3D%20ExampleClassifier().set_fit_request(sample_weight%3DFalse).set_predict_request(groups%3DTrue).set_score_request(sample_weight%3DFalse)%0A%20%20%20%20print_routing(_est)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20..%20note%20%3A%3A%0A%20%20%20%20%20%20%20%20Please%20note%20that%20as%20long%20as%20the%20above%20estimator%20is%20not%20used%20in%20a%0A%20%20%20%20%20%20%20%20meta-estimator%2C%20the%20user%20does%20not%20need%20to%20set%20any%20requests%20for%20the%0A%20%20%20%20%20%20%20%20metadata%20and%20the%20set%20values%20are%20ignored%2C%20since%20a%20consumer%20does%20not%0A%20%20%20%20%20%20%20%20validate%20or%20route%20given%20metadata.%20A%20simple%20usage%20of%20the%20above%20estimator%0A%20%20%20%20%20%20%20%20would%20work%20as%20expected.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20X%2C%20my_groups%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20_est%20%3D%20ExampleClassifier()%0A%20%20%20%20_est.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights)%0A%20%20%20%20_est.predict(X%5B%3A3%2C%20%3A%5D%2C%20groups%3Dmy_groups)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Routing%20Meta-Estimator%0A%20%20%20%20Now%2C%20we%20show%20how%20to%20design%20a%20meta-estimator%20to%20be%20a%20router.%20As%20a%20simplified%0A%20%20%20%20example%2C%20here%20is%20a%20meta-estimator%2C%20which%20doesn't%20do%20much%20other%20than%20routing%0A%20%20%20%20the%20metadata.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BaseEstimator%2C%0A%20%20%20%20ClassifierMixin%2C%0A%20%20%20%20MetaEstimatorMixin%2C%0A%20%20%20%20MetadataRouter%2C%0A%20%20%20%20MethodMapping%2C%0A%20%20%20%20check_is_fitted%2C%0A%20%20%20%20clone%2C%0A%20%20%20%20get_routing_for_object%2C%0A)%3A%0A%20%20%20%20class%20MetaClassifier(MetaEstimatorMixin%2C%20ClassifierMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20estimator)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator%20%3D%20estimator%0A%0A%20%20%20%20%20%20%20%20def%20get_metadata_routing(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20This%20method%20defines%20the%20routing%20for%20this%20meta-estimator.%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20In%20order%20to%20do%20so%2C%20a%20%60MetadataRouter%60%20instance%20is%20created%2C%20and%20the%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20routing%20is%20added%20to%20it.%20More%20explanations%20follow%20below.%0A%20%20%20%20%20%20%20%20%20%20%20%20router%20%3D%20MetadataRouter(owner%3Dself).add(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20estimator%3Dself.estimator%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_mapping%3DMethodMapping()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22fit%22%2C%20callee%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22predict%22%2C%20callee%3D%22predict%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22score%22%2C%20callee%3D%22score%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20router%0A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20**fit_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20%60get_routing_for_object%60%20returns%20a%20copy%20of%20the%20%60MetadataRouter%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20constructed%20by%20the%20above%20%60get_metadata_routing%60%20method%2C%20that%20is%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20internally%20called.%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router%20%3D%20get_routing_for_object(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Meta-estimators%20are%20responsible%20for%20validating%20the%20given%20metadata.%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20%60method%60%20refers%20to%20the%20parent's%20method%2C%20i.e.%20%60fit%60%20in%20this%20example.%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router.validate_metadata(params%3Dfit_params%2C%20method%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20%60MetadataRouter.route_params%60%20maps%20the%20given%20metadata%20to%20the%20metadata%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20required%20by%20the%20underlying%20estimator%20based%20on%20the%20routing%20information%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20defined%20by%20the%20MetadataRouter.%20The%20output%20of%20type%20%60Bunch%60%20has%20a%20key%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20for%20each%20consuming%20object%20and%20those%20hold%20keys%20for%20their%20consuming%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20methods%2C%20which%20then%20contain%20key%20for%20the%20metadata%20which%20should%20be%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20routed%20to%20them.%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20request_router.route_params(params%3Dfit_params%2C%20caller%3D%22fit%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20A%20sub-estimator%20is%20fitted%20and%20its%20classes%20are%20attributed%20to%20the%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20meta-estimator.%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator_%20%3D%20clone(self.estimator).fit(X%2C%20y%2C%20**routed_params.estimator.fit)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.classes_%20%3D%20self.estimator_.classes_%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self%0A%0A%20%20%20%20%20%20%20%20def%20predict(self%2C%20X%2C%20**predict_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_is_fitted(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20As%20in%20%60fit%60%2C%20we%20get%20a%20copy%20of%20the%20object's%20MetadataRouter%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router%20%3D%20get_routing_for_object(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20then%20we%20validate%20the%20given%20metadata%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router.validate_metadata(params%3Dpredict_params%2C%20method%3D%22predict%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20and%20then%20prepare%20the%20input%20to%20the%20underlying%20%60predict%60%20method.%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20request_router.route_params(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20params%3Dpredict_params%2C%20caller%3D%22predict%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.estimator_.predict(X%2C%20**routed_params.estimator.predict)%0A%20%20%20%20return%20(MetaClassifier%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Let's%20break%20down%20different%20parts%20of%20the%20above%20code.%0A%0A%20%20%20%20First%2C%20the%20%3Ameth%3A%60~utils.metadata_routing.get_routing_for_object%60%20takes%20our%0A%20%20%20%20meta-estimator%20(%60%60self%60%60)%20and%20returns%20a%0A%20%20%20%20%3Aclass%3A%60~utils.metadata_routing.MetadataRouter%60%20or%2C%20a%0A%20%20%20%20%3Aclass%3A%60~utils.metadata_routing.MetadataRequest%60%20if%20the%20object%20is%20a%20consumer%2C%0A%20%20%20%20based%20on%20the%20output%20of%20the%20estimator's%20%60%60get_metadata_routing%60%60%20method.%0A%0A%20%20%20%20Then%20in%20each%20method%2C%20we%20use%20the%20%60%60route_params%60%60%20method%20to%20construct%20a%0A%20%20%20%20dictionary%20of%20the%20form%20%60%60%7B%22object_name%22%3A%20%7B%22method_name%22%3A%20%7B%22metadata%22%3A%0A%20%20%20%20value%7D%7D%7D%60%60%20to%20pass%20to%20the%20underlying%20estimator's%20method.%20The%20%60%60object_name%60%60%0A%20%20%20%20(%60%60estimator%60%60%20in%20the%20above%20%60%60routed_params.estimator.fit%60%60%20example)%20is%20the%0A%20%20%20%20same%20as%20the%20one%20added%20in%20the%20%60%60get_metadata_routing%60%60.%20%60%60validate_metadata%60%60%0A%20%20%20%20makes%20sure%20all%20given%20metadata%20are%20requested%20to%20avoid%20silent%20bugs.%0A%0A%20%20%20%20Next%2C%20we%20illustrate%20the%20different%20behaviors%20and%20notably%20the%20type%20of%20errors%0A%20%20%20%20raised.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20MetaClassifier%2C%20X%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20meta_est%20%3D%20MetaClassifier(%0A%20%20%20%20%20%20%20%20estimator%3DExampleClassifier().set_fit_request(sample_weight%3DTrue)%0A%20%20%20%20)%0A%20%20%20%20meta_est.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights)%0A%20%20%20%20return%20(meta_est%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Note%20that%20the%20above%20example%20is%20calling%20our%20utility%20function%0A%20%20%20%20%60check_metadata()%60%20via%20the%20%60ExampleClassifier%60.%20It%20checks%20that%0A%20%20%20%20%60%60sample_weight%60%60%20is%20correctly%20passed%20to%20it.%20If%20it%20is%20not%2C%20like%20in%20the%0A%20%20%20%20following%20example%2C%20it%20would%20print%20that%20%60%60sample_weight%60%60%20is%20%60%60None%60%60%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(X%2C%20meta_est%2C%20y)%3A%0A%20%20%20%20meta_est.fit(X%2C%20y)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20If%20we%20pass%20an%20unknown%20metadata%2C%20an%20error%20is%20raised%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(X%2C%20meta_est%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20meta_est.fit(X%2C%20y%2C%20test%3Dmy_weights)%0A%20%20%20%20except%20TypeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20print(e)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20And%20if%20we%20pass%20a%20metadata%20which%20is%20not%20explicitly%20requested%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(X%2C%20meta_est%2C%20my_groups%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20meta_est.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights).predict(X%2C%20groups%3Dmy_groups)%0A%20%20%20%20except%20ValueError%20as%20e%3A%0A%20%20%20%20%20%20%20%20print(e)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Also%2C%20if%20we%20explicitly%20set%20it%20as%20not%20requested%2C%20but%20it%20is%20provided%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20MetaClassifier%2C%20X%2C%20my_groups%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20meta_est_1%20%3D%20MetaClassifier(estimator%3DExampleClassifier().set_fit_request(sample_weight%3DTrue).set_predict_request(groups%3DFalse))%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20meta_est_1.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights).predict(X%5B%3A3%2C%20%3A%5D%2C%20groups%3Dmy_groups)%0A%20%20%20%20except%20TypeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20print(e)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Another%20concept%20to%20introduce%20is%20**aliased%20metadata**.%20This%20is%20when%20an%0A%20%20%20%20estimator%20requests%20a%20metadata%20with%20a%20different%20variable%20name%20than%20the%20default%0A%20%20%20%20variable%20name.%20For%20instance%2C%20in%20a%20setting%20where%20there%20are%20two%20estimators%20in%20a%0A%20%20%20%20pipeline%2C%20one%20could%20request%20%60%60sample_weight1%60%60%20and%20the%20other%0A%20%20%20%20%60%60sample_weight2%60%60.%20Note%20that%20this%20doesn't%20change%20what%20the%20estimator%20expects%2C%0A%20%20%20%20it%20only%20tells%20the%20meta-estimator%20how%20to%20map%20the%20provided%20metadata%20to%20what%20is%0A%20%20%20%20required.%20Here's%20an%20example%2C%20where%20we%20pass%20%60%60aliased_sample_weight%60%60%20to%20the%0A%20%20%20%20meta-estimator%2C%20but%20the%20meta-estimator%20understands%20that%0A%20%20%20%20%60%60aliased_sample_weight%60%60%20is%20an%20alias%20for%20%60%60sample_weight%60%60%2C%20and%20passes%20it%20as%0A%20%20%20%20%60%60sample_weight%60%60%20to%20the%20underlying%20estimator%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20MetaClassifier%2C%20X%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20meta_est_2%20%3D%20MetaClassifier(estimator%3DExampleClassifier().set_fit_request(sample_weight%3D'aliased_sample_weight'))%0A%20%20%20%20meta_est_2.fit(X%2C%20y%2C%20aliased_sample_weight%3Dmy_weights)%0A%20%20%20%20return%20(meta_est_2%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Passing%20%60%60sample_weight%60%60%20here%20will%20fail%20since%20it%20is%20requested%20with%20an%0A%20%20%20%20alias%20and%20%60%60sample_weight%60%60%20with%20that%20name%20is%20not%20requested%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(X%2C%20meta_est_2%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20try%3A%0A%20%20%20%20%20%20%20%20meta_est_2.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights)%0A%20%20%20%20except%20TypeError%20as%20e%3A%0A%20%20%20%20%20%20%20%20print(e)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20This%20leads%20us%20to%20the%20%60%60get_metadata_routing%60%60.%20The%20way%20routing%20works%20in%0A%20%20%20%20scikit-learn%20is%20that%20consumers%20request%20what%20they%20need%2C%20and%20routers%20pass%20that%0A%20%20%20%20along.%20Additionally%2C%20a%20router%20exposes%20what%20it%20requires%20itself%20so%20that%20it%20can%0A%20%20%20%20be%20used%20inside%20another%20router%2C%20e.g.%20a%20pipeline%20inside%20a%20grid%20search%20object.%0A%20%20%20%20The%20output%20of%20the%20%60%60get_metadata_routing%60%60%20which%20is%20a%20dictionary%0A%20%20%20%20representation%20of%20a%20%3Aclass%3A%60~utils.metadata_routing.MetadataRouter%60%2C%20includes%0A%20%20%20%20the%20complete%20tree%20of%20requested%20metadata%20by%20all%20nested%20objects%20and%20their%0A%20%20%20%20corresponding%20method%20routings%2C%20i.e.%20which%20method%20of%20a%20sub-estimator%20is%20used%0A%20%20%20%20in%20which%20method%20of%20a%20meta-estimator%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(meta_est_2%2C%20print_routing)%3A%0A%20%20%20%20print_routing(meta_est_2)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20As%20you%20can%20see%2C%20the%20only%20metadata%20requested%20for%20method%20%60%60fit%60%60%20is%0A%20%20%20%20%60%60%22sample_weight%22%60%60%20with%20%60%60%22aliased_sample_weight%22%60%60%20as%20the%20alias.%20The%0A%20%20%20%20%60%60~utils.metadata_routing.MetadataRouter%60%60%20class%20enables%20us%20to%20easily%20create%0A%20%20%20%20the%20routing%20object%20which%20would%20create%20the%20output%20we%20need%20for%20our%0A%20%20%20%20%60%60get_metadata_routing%60%60.%0A%0A%20%20%20%20In%20order%20to%20understand%20how%20aliases%20work%20in%20meta-estimators%2C%20imagine%20our%0A%20%20%20%20meta-estimator%20inside%20another%20one%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(MetaClassifier%2C%20X%2C%20meta_est_2%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20meta_meta_est%20%3D%20MetaClassifier(estimator%3Dmeta_est_2).fit(X%2C%20y%2C%20aliased_sample_weight%3Dmy_weights)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20In%20the%20above%20example%2C%20this%20is%20how%20the%20%60%60fit%60%60%20method%20of%20%60meta_meta_est%60%0A%20%20%20%20will%20call%20their%20sub-estimator's%20%60%60fit%60%60%20methods%3A%3A%0A%0A%20%20%20%20%20%20%20%20%23%20user%20feeds%20%60my_weights%60%20as%20%60aliased_sample_weight%60%20into%20%60meta_meta_est%60%3A%0A%20%20%20%20%20%20%20%20meta_meta_est.fit(X%2C%20y%2C%20aliased_sample_weight%3Dmy_weights)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20...%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20the%20first%20sub-estimator%20(%60meta_est%60)%20expects%20%60aliased_sample_weight%60%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator_.fit(X%2C%20y%2C%20aliased_sample_weight%3Daliased_sample_weight)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20...%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20the%20second%20sub-estimator%20(%60est%60)%20expects%20%60sample_weight%60%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self.estimator_.fit(X%2C%20y%2C%20sample_weight%3Daliased_sample_weight)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20...%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Consuming%20and%20routing%20Meta-Estimator%0A%20%20%20%20For%20a%20slightly%20more%20complex%20example%2C%20consider%20a%20meta-estimator%20that%20routes%0A%20%20%20%20metadata%20to%20an%20underlying%20estimator%20as%20before%2C%20but%20it%20also%20uses%20some%20metadata%0A%20%20%20%20in%20its%20own%20methods.%20This%20meta-estimator%20is%20a%20consumer%20and%20a%20router%20at%20the%0A%20%20%20%20same%20time.%20Implementing%20one%20is%20very%20similar%20to%20what%20we%20had%20before%2C%20but%20with%20a%0A%20%20%20%20few%20tweaks.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BaseEstimator%2C%0A%20%20%20%20ClassifierMixin%2C%0A%20%20%20%20MetaEstimatorMixin%2C%0A%20%20%20%20MetadataRouter%2C%0A%20%20%20%20MethodMapping%2C%0A%20%20%20%20check_is_fitted%2C%0A%20%20%20%20clone%2C%0A%20%20%20%20get_routing_for_object%2C%0A)%3A%0A%20%20%20%20class%20RouterConsumerClassifier(MetaEstimatorMixin%2C%20ClassifierMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20estimator)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator%20%3D%20estimator%0A%0A%20%20%20%20%20%20%20%20def%20get_metadata_routing(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20router%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20MetadataRouter(owner%3Dself)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20defining%20metadata%20routing%20request%20values%20for%20usage%20in%20the%20meta-estimator%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add_self_request(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20defining%20metadata%20routing%20request%20values%20for%20usage%20in%20the%20sub-estimator%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20estimator%3Dself.estimator%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_mapping%3DMethodMapping()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22fit%22%2C%20callee%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22predict%22%2C%20callee%3D%22predict%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22score%22%2C%20callee%3D%22score%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20router%0A%0A%20%20%20%20%20%20%20%20%23%20Since%20%60sample_weight%60%20is%20used%20and%20consumed%20here%2C%20it%20should%20be%20defined%20as%0A%20%20%20%20%20%20%20%20%23%20an%20explicit%20argument%20in%20the%20method's%20signature.%20All%20other%20metadata%20which%0A%20%20%20%20%20%20%20%20%23%20are%20only%20routed%2C%20will%20be%20passed%20as%20%60**fit_params%60%3A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20sample_weight%2C%20**fit_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20self.estimator%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(%22estimator%20cannot%20be%20None!%22)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20sample_weight%3Dsample_weight)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20We%20add%20%60sample_weight%60%20to%20the%20%60fit_params%60%20dictionary.%0A%20%20%20%20%20%20%20%20%20%20%20%20if%20sample_weight%20is%20not%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fit_params%5B%22sample_weight%22%5D%20%3D%20sample_weight%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router%20%3D%20get_routing_for_object(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router.validate_metadata(params%3Dfit_params%2C%20method%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20request_router.route_params(params%3Dfit_params%2C%20caller%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator_%20%3D%20clone(self.estimator).fit(X%2C%20y%2C%20**routed_params.estimator.fit)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.classes_%20%3D%20self.estimator_.classes_%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self%0A%0A%20%20%20%20%20%20%20%20def%20predict(self%2C%20X%2C%20**predict_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_is_fitted(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20As%20in%20%60fit%60%2C%20we%20get%20a%20copy%20of%20the%20object's%20MetadataRouter%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router%20%3D%20get_routing_for_object(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20we%20validate%20the%20given%20metadata%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20request_router.validate_metadata(params%3Dpredict_params%2C%20method%3D%22predict%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20and%20then%20prepare%20the%20input%20to%20the%20underlying%20%60%60predict%60%60%20method.%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20request_router.route_params(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20params%3Dpredict_params%2C%20caller%3D%22predict%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.estimator_.predict(X%2C%20**routed_params.estimator.predict)%0A%20%20%20%20return%20(RouterConsumerClassifier%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20key%20parts%20where%20the%20above%20meta-estimator%20differs%20from%20our%20previous%0A%20%20%20%20meta-estimator%20is%20accepting%20%60%60sample_weight%60%60%20explicitly%20in%20%60%60fit%60%60%20and%0A%20%20%20%20including%20it%20in%20%60%60fit_params%60%60.%20Since%20%60%60sample_weight%60%60%20is%20an%20explicit%0A%20%20%20%20argument%2C%20we%20can%20be%20sure%20that%20%60%60set_fit_request(sample_weight%3D...)%60%60%20is%0A%20%20%20%20present%20for%20this%20method.%20The%20meta-estimator%20is%20both%20a%20consumer%2C%20as%20well%20as%20a%0A%20%20%20%20router%20of%20%60%60sample_weight%60%60.%0A%0A%20%20%20%20In%20%60%60get_metadata_routing%60%60%2C%20we%20add%20%60%60self%60%60%20to%20the%20routing%20using%0A%20%20%20%20%60%60add_self_request%60%60%20to%20indicate%20this%20estimator%20is%20consuming%0A%20%20%20%20%60%60sample_weight%60%60%20as%20well%20as%20being%20a%20router%3B%20which%20also%20adds%20a%0A%20%20%20%20%60%60%24self_request%60%60%20key%20to%20the%20routing%20info%20as%20illustrated%20below.%20Now%20let's%0A%20%20%20%20look%20at%20some%20examples%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20-%20No%20metadata%20requested%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20RouterConsumerClassifier%2C%20print_routing)%3A%0A%20%20%20%20meta_est_3%20%3D%20RouterConsumerClassifier(estimator%3DExampleClassifier())%0A%20%20%20%20print_routing(meta_est_3)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20-%20%60%60sample_weight%60%60%20requested%20by%20sub-estimator%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20RouterConsumerClassifier%2C%20print_routing)%3A%0A%20%20%20%20meta_est_4%20%3D%20RouterConsumerClassifier(estimator%3DExampleClassifier().set_fit_request(sample_weight%3DTrue))%0A%20%20%20%20print_routing(meta_est_4)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20-%20%60%60sample_weight%60%60%20requested%20by%20meta-estimator%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20RouterConsumerClassifier%2C%20print_routing)%3A%0A%20%20%20%20meta_est_5%20%3D%20RouterConsumerClassifier(estimator%3DExampleClassifier()).set_fit_request(sample_weight%3DTrue)%0A%20%20%20%20print_routing(meta_est_5)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Note%20the%20difference%20in%20the%20requested%20metadata%20representations%20above.%0A%0A%20%20%20%20-%20We%20can%20also%20alias%20the%20metadata%20to%20pass%20different%20values%20to%20the%20fit%20methods%0A%20%20%20%20%20%20of%20the%20meta-%20and%20the%20sub-estimator%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20RouterConsumerClassifier%2C%20print_routing)%3A%0A%20%20%20%20meta_est_6%20%3D%20RouterConsumerClassifier(estimator%3DExampleClassifier().set_fit_request(sample_weight%3D'clf_sample_weight')).set_fit_request(sample_weight%3D'meta_clf_sample_weight')%0A%20%20%20%20print_routing(meta_est_6)%0A%20%20%20%20return%20(meta_est_6%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20However%2C%20%60%60fit%60%60%20of%20the%20meta-estimator%20only%20needs%20the%20alias%20for%20the%0A%20%20%20%20sub-estimator%20and%20addresses%20their%20own%20sample%20weight%20as%20%60sample_weight%60%2C%20since%0A%20%20%20%20it%20doesn't%20validate%20and%20route%20its%20own%20required%20metadata%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(X%2C%20meta_est_6%2C%20my_other_weights%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20meta_est_6.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights%2C%20clf_sample_weight%3Dmy_other_weights)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20-%20Alias%20only%20on%20the%20sub-estimator%3A%0A%0A%20%20%20%20This%20is%20useful%20when%20we%20don't%20want%20the%20meta-estimator%20to%20use%20the%20metadata%2C%20but%0A%20%20%20%20the%20sub-estimator%20should.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(ExampleClassifier%2C%20RouterConsumerClassifier%2C%20print_routing)%3A%0A%20%20%20%20meta_est_7%20%3D%20RouterConsumerClassifier(estimator%3DExampleClassifier().set_fit_request(sample_weight%3D'aliased_sample_weight'))%0A%20%20%20%20print_routing(meta_est_7)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20meta-estimator%20cannot%20use%20%60aliased_sample_weight%60%2C%20because%20it%20expects%0A%20%20%20%20it%20passed%20as%20%60sample_weight%60.%20This%20would%20apply%20even%20if%0A%20%20%20%20%60set_fit_request(sample_weight%3DTrue)%60%20was%20set%20on%20it.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Simple%20Pipeline%0A%20%20%20%20A%20slightly%20more%20complicated%20use-case%20is%20a%20meta-estimator%20resembling%20a%0A%20%20%20%20%3Aclass%3A%60~pipeline.Pipeline%60.%20Here%20is%20a%20meta-estimator%2C%20which%20accepts%20a%0A%20%20%20%20transformer%20and%20a%20classifier.%20When%20calling%20its%20%60fit%60%20method%2C%20it%20applies%20the%0A%20%20%20%20transformer's%20%60fit%60%20and%20%60transform%60%20before%20running%20the%20classifier%20on%20the%0A%20%20%20%20transformed%20data.%20Upon%20%60predict%60%2C%20it%20applies%20the%20transformer's%20%60transform%60%0A%20%20%20%20before%20predicting%20with%20the%20classifier's%20%60predict%60%20method%20on%20the%20transformed%0A%20%20%20%20new%20data.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BaseEstimator%2C%0A%20%20%20%20ClassifierMixin%2C%0A%20%20%20%20MetadataRouter%2C%0A%20%20%20%20MethodMapping%2C%0A%20%20%20%20clone%2C%0A%20%20%20%20process_routing%2C%0A)%3A%0A%20%20%20%20class%20SimplePipeline(ClassifierMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20transformer%2C%20classifier)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.transformer%20%3D%20transformer%0A%20%20%20%20%20%20%20%20%20%20%20%20self.classifier%20%3D%20classifier%0A%0A%20%20%20%20%20%20%20%20def%20get_metadata_routing(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20router%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20MetadataRouter(owner%3Dself)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20We%20add%20the%20routing%20for%20the%20transformer.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20transformer%3Dself.transformer%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_mapping%3DMethodMapping()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20The%20metadata%20is%20routed%20such%20that%20it%20retraces%20how%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%60SimplePipeline%60%20internally%20calls%20the%20transformer's%20%60fit%60%20and%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20%60transform%60%20methods%20in%20its%20own%20methods%20(%60fit%60%20and%20%60predict%60).%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22fit%22%2C%20callee%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22fit%22%2C%20callee%3D%22transform%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22predict%22%2C%20callee%3D%22transform%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%23%20We%20add%20the%20routing%20for%20the%20classifier.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20classifier%3Dself.classifier%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_mapping%3DMethodMapping()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22fit%22%2C%20callee%3D%22fit%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(caller%3D%22predict%22%2C%20callee%3D%22predict%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20router%0A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20**fit_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20process_routing(self%2C%20%22fit%22%2C%20**fit_params)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.transformer_%20%3D%20clone(self.transformer).fit(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X%2C%20y%2C%20**routed_params.transformer.fit%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20X_transformed%20%3D%20self.transformer_.transform(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X%2C%20**routed_params.transformer.transform%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.classifier_%20%3D%20clone(self.classifier).fit(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_transformed%2C%20y%2C%20**routed_params.classifier.fit%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self%0A%0A%20%20%20%20%20%20%20%20def%20predict(self%2C%20X%2C%20**predict_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20process_routing(self%2C%20%22predict%22%2C%20**predict_params)%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20X_transformed%20%3D%20self.transformer_.transform(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X%2C%20**routed_params.transformer.transform%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.classifier_.predict(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20X_transformed%2C%20**routed_params.classifier.predict%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20return%20(SimplePipeline%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Note%20the%20usage%20of%20%3Aclass%3A%60~utils.metadata_routing.MethodMapping%60%20to%0A%20%20%20%20declare%20which%20methods%20of%20the%20child%20estimator%20(callee)%20are%20used%20in%20which%0A%20%20%20%20methods%20of%20the%20meta%20estimator%20(caller).%20As%20you%20can%20see%2C%20%60SimplePipeline%60%20uses%0A%20%20%20%20the%20transformer's%20%60%60transform%60%60%20and%20%60%60fit%60%60%20methods%20in%20%60%60fit%60%60%2C%20and%20its%0A%20%20%20%20%60%60transform%60%60%20method%20in%20%60%60predict%60%60%2C%20and%20that's%20what%20you%20see%20implemented%20in%0A%20%20%20%20the%20routing%20structure%20of%20the%20pipeline%20class.%0A%0A%20%20%20%20Another%20difference%20in%20the%20above%20example%20with%20the%20previous%20ones%20is%20the%20usage%0A%20%20%20%20of%20%3Afunc%3A%60~utils.metadata_routing.process_routing%60%2C%20which%20processes%20the%20input%0A%20%20%20%20parameters%2C%20does%20the%20required%20validation%2C%20and%20returns%20the%20%60routed_params%60%0A%20%20%20%20which%20we%20had%20created%20in%20previous%20examples.%20This%20reduces%20the%20boilerplate%20code%0A%20%20%20%20a%20developer%20needs%20to%20write%20in%20each%20meta-estimator's%20method.%20Developers%20are%0A%20%20%20%20strongly%20recommended%20to%20use%20this%20function%20unless%20there%20is%20a%20good%20reason%0A%20%20%20%20against%20it.%0A%0A%20%20%20%20In%20order%20to%20test%20the%20above%20pipeline%2C%20let's%20add%20an%20example%20transformer.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(BaseEstimator%2C%20TransformerMixin)%3A%0A%20%20%20%20class%20ExampleTransformer(TransformerMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20sample_weight%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20sample_weight%3Dsample_weight)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self%0A%0A%20%20%20%20%20%20%20%20def%20transform(self%2C%20X%2C%20groups%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20groups%3Dgroups)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20X%0A%0A%20%20%20%20%20%20%20%20def%20fit_transform(self%2C%20X%2C%20y%2C%20sample_weight%3DNone%2C%20groups%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self.fit(X%2C%20y%2C%20sample_weight).transform(X%2C%20groups)%0A%20%20%20%20return%20(ExampleTransformer%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Note%20that%20in%20the%20above%20example%2C%20we%20have%20implemented%20%60%60fit_transform%60%60%20which%0A%20%20%20%20calls%20%60%60fit%60%60%20and%20%60%60transform%60%60%20with%20the%20appropriate%20metadata.%20This%20is%20only%0A%20%20%20%20required%20if%20%60%60transform%60%60%20accepts%20metadata%2C%20since%20the%20default%20%60%60fit_transform%60%60%0A%20%20%20%20implementation%20in%20%3Aclass%3A%60~base.TransformerMixin%60%20doesn't%20pass%20metadata%20to%0A%20%20%20%20%60%60transform%60%60.%0A%0A%20%20%20%20Now%20we%20can%20test%20our%20pipeline%2C%20and%20see%20if%20metadata%20is%20correctly%20passed%20around.%0A%20%20%20%20This%20example%20uses%20our%20%60SimplePipeline%60%2C%20our%20%60ExampleTransformer%60%2C%20and%20our%0A%20%20%20%20%60RouterConsumerClassifier%60%20which%20uses%20our%20%60ExampleClassifier%60.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20ExampleClassifier%2C%0A%20%20%20%20ExampleTransformer%2C%0A%20%20%20%20RouterConsumerClassifier%2C%0A%20%20%20%20SimplePipeline%2C%0A%20%20%20%20X%2C%0A%20%20%20%20my_groups%2C%0A%20%20%20%20my_weights%2C%0A%20%20%20%20y%2C%0A)%3A%0A%20%20%20%20pipe%20%3D%20SimplePipeline(%0A%20%20%20%20%20%20%20%20transformer%3DExampleTransformer()%0A%20%20%20%20%20%20%20%20%23%20we%20set%20transformer's%20fit%20to%20receive%20sample_weight%0A%20%20%20%20%20%20%20%20.set_fit_request(sample_weight%3DTrue)%0A%20%20%20%20%20%20%20%20%23%20we%20set%20transformer's%20transform%20to%20receive%20groups%0A%20%20%20%20%20%20%20%20.set_transform_request(groups%3DTrue)%2C%0A%20%20%20%20%20%20%20%20classifier%3DRouterConsumerClassifier(%0A%20%20%20%20%20%20%20%20%20%20%20%20estimator%3DExampleClassifier()%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20we%20want%20this%20sub-estimator%20to%20receive%20sample_weight%20in%20fit%0A%20%20%20%20%20%20%20%20%20%20%20%20.set_fit_request(sample_weight%3DTrue)%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20but%20not%20groups%20in%20predict%0A%20%20%20%20%20%20%20%20%20%20%20%20.set_predict_request(groups%3DFalse)%2C%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%23%20and%20we%20want%20the%20meta-estimator%20to%20receive%20sample_weight%20as%20well%0A%20%20%20%20%20%20%20%20.set_fit_request(sample_weight%3DTrue)%2C%0A%20%20%20%20)%0A%20%20%20%20pipe.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights%2C%20groups%3Dmy_groups).predict(%0A%20%20%20%20%20%20%20%20X%5B%3A3%5D%2C%20groups%3Dmy_groups%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Deprecation%20%2F%20Default%20Value%20Change%0A%20%20%20%20In%20this%20section%20we%20show%20how%20one%20should%20handle%20the%20case%20where%20a%20router%20becomes%0A%20%20%20%20also%20a%20consumer%2C%20especially%20when%20it%20consumes%20the%20same%20metadata%20as%20its%0A%20%20%20%20sub-estimator%2C%20or%20a%20consumer%20starts%20consuming%20a%20metadata%20which%20it%20wasn't%20in%0A%20%20%20%20an%20older%20release.%20In%20this%20case%2C%20a%20warning%20should%20be%20raised%20for%20a%20while%2C%20to%0A%20%20%20%20let%20users%20know%20the%20behavior%20is%20changed%20from%20previous%20versions.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BaseEstimator%2C%0A%20%20%20%20MetaEstimatorMixin%2C%0A%20%20%20%20MetadataRouter%2C%0A%20%20%20%20MethodMapping%2C%0A%20%20%20%20RegressorMixin%2C%0A%20%20%20%20clone%2C%0A%20%20%20%20process_routing%2C%0A)%3A%0A%20%20%20%20class%20MetaRegressor(MetaEstimatorMixin%2C%20RegressorMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20estimator)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator%20%3D%20estimator%0A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20**fit_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20process_routing(self%2C%20%22fit%22%2C%20**fit_params)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator_%20%3D%20clone(self.estimator).fit(X%2C%20y%2C%20**routed_params.estimator.fit)%0A%0A%20%20%20%20%20%20%20%20def%20get_metadata_routing(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20router%20%3D%20MetadataRouter(owner%3Dself).add(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20estimator%3Dself.estimator%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_mapping%3DMethodMapping().add(caller%3D%22fit%22%2C%20callee%3D%22fit%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20router%0A%20%20%20%20return%20(MetaRegressor%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20As%20explained%20above%2C%20this%20is%20a%20valid%20usage%20if%20%60my_weights%60%20aren't%20supposed%0A%20%20%20%20to%20be%20passed%20as%20%60sample_weight%60%20to%20%60MetaRegressor%60%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(LinearRegression%2C%20MetaRegressor%2C%20X%2C%20my_weights%2C%20y)%3A%0A%20%20%20%20reg%20%3D%20MetaRegressor(estimator%3DLinearRegression().set_fit_request(sample_weight%3DTrue))%0A%20%20%20%20reg.fit(X%2C%20y%2C%20sample_weight%3Dmy_weights)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20Now%20imagine%20we%20further%20develop%20%60%60MetaRegressor%60%60%20and%20it%20now%20also%20*consumes*%0A%20%20%20%20%60%60sample_weight%60%60%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BaseEstimator%2C%0A%20%20%20%20MetaEstimatorMixin%2C%0A%20%20%20%20MetadataRouter%2C%0A%20%20%20%20MethodMapping%2C%0A%20%20%20%20RegressorMixin%2C%0A%20%20%20%20clone%2C%0A%20%20%20%20metadata_routing%2C%0A%20%20%20%20process_routing%2C%0A)%3A%0A%20%20%20%20class%20WeightedMetaRegressor(MetaEstimatorMixin%2C%20RegressorMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20%23%20show%20warning%20to%20remind%20user%20to%20explicitly%20set%20the%20value%20with%0A%20%20%20%20%20%20%20%20%23%20%60.set_%7Bmethod%7D_request(sample_weight%3D%7Bboolean%7D)%60%0A%20%20%20%20%20%20%20%20__metadata_request__fit%20%3D%20%7B%22sample_weight%22%3A%20metadata_routing.WARN%7D%0A%0A%20%20%20%20%20%20%20%20def%20__init__(self%2C%20estimator)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator%20%3D%20estimator%0A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20sample_weight%3DNone%2C%20**fit_params)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20routed_params%20%3D%20process_routing(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20self%2C%20%22fit%22%2C%20sample_weight%3Dsample_weight%2C%20**fit_params%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20sample_weight%3Dsample_weight)%0A%20%20%20%20%20%20%20%20%20%20%20%20self.estimator_%20%3D%20clone(self.estimator).fit(X%2C%20y%2C%20**routed_params.estimator.fit)%0A%0A%20%20%20%20%20%20%20%20def%20get_metadata_routing(self)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20router%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20MetadataRouter(owner%3Dself)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add_self_request(self)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20.add(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20estimator%3Dself.estimator%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20method_mapping%3DMethodMapping().add(caller%3D%22fit%22%2C%20callee%3D%22fit%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20router%0A%20%20%20%20return%20(WeightedMetaRegressor%2C)%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20The%20above%20implementation%20is%20almost%20the%20same%20as%20%60%60MetaRegressor%60%60%2C%20and%0A%20%20%20%20because%20of%20the%20default%20request%20value%20defined%20in%20%60%60__metadata_request__fit%60%60%0A%20%20%20%20there%20is%20a%20warning%20raised%20when%20fitted.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(LinearRegression%2C%20WeightedMetaRegressor%2C%20X%2C%20my_weights%2C%20warnings%2C%20y)%3A%0A%20%20%20%20with%20warnings.catch_warnings(record%3DTrue)%20as%20_record%3A%0A%20%20%20%20%20%20%20%20WeightedMetaRegressor(estimator%3DLinearRegression().set_fit_request(sample_weight%3DFalse)).fit(X%2C%20y%2C%20sample_weight%3Dmy_weights)%0A%20%20%20%20for%20_w%20in%20_record%3A%0A%20%20%20%20%20%20%20%20print(_w.message)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20When%20an%20estimator%20consumes%20a%20metadata%20which%20it%20didn't%20consume%20before%2C%20the%0A%20%20%20%20following%20pattern%20can%20be%20used%20to%20warn%20the%20users%20about%20it.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20BaseEstimator%2C%0A%20%20%20%20MetaRegressor%2C%0A%20%20%20%20RegressorMixin%2C%0A%20%20%20%20X%2C%0A%20%20%20%20metadata_routing%2C%0A%20%20%20%20my_weights%2C%0A%20%20%20%20np%2C%0A%20%20%20%20warnings%2C%0A%20%20%20%20y%2C%0A)%3A%0A%20%20%20%20class%20ExampleRegressor(RegressorMixin%2C%20BaseEstimator)%3A%0A%20%20%20%20%20%20%20%20__metadata_request__fit%20%3D%20%7B'sample_weight'%3A%20metadata_routing.WARN%7D%0A%0A%20%20%20%20%20%20%20%20def%20fit(self%2C%20X%2C%20y%2C%20sample_weight%3DNone)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20check_metadata(self%2C%20sample_weight%3Dsample_weight)%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20self%0A%0A%20%20%20%20%20%20%20%20def%20predict(self%2C%20X)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20np.zeros(shape%3Dlen(X))%0A%20%20%20%20with%20warnings.catch_warnings(record%3DTrue)%20as%20_record%3A%0A%20%20%20%20%20%20%20%20MetaRegressor(estimator%3DExampleRegressor()).fit(X%2C%20y%2C%20sample_weight%3Dmy_weights)%0A%20%20%20%20for%20_w%20in%20_record%3A%0A%20%20%20%20%20%20%20%20print(_w.message)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20At%20the%20end%20we%20disable%20the%20configuration%20flag%20for%20metadata%20routing%3A%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(set_config)%3A%0A%20%20%20%20set_config(enable_metadata_routing%3DFalse)%0A%20%20%20%20return%0A%0A%0A%40app.cell(hide_code%3DTrue)%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20r%22%22%22%0A%20%20%20%20%23%23%20Third%20Party%20Development%20and%20scikit-learn%20Dependency%0A%0A%20%20%20%20As%20seen%20above%2C%20information%20is%20communicated%20between%20classes%20using%0A%20%20%20%20%3Aclass%3A%60~utils.metadata_routing.MetadataRequest%60%20and%0A%20%20%20%20%3Aclass%3A%60~utils.metadata_routing.MetadataRouter%60.%20It%20is%20strongly%20not%20advised%2C%0A%20%20%20%20but%20possible%20to%20vendor%20the%20tools%20related%20to%20metadata-routing%20if%20you%20strictly%0A%20%20%20%20want%20to%20have%20a%20scikit-learn%20compatible%20estimator%2C%20without%20depending%20on%20the%0A%20%20%20%20scikit-learn%20package.%20If%20all%20of%20the%20following%20conditions%20are%20met%2C%20you%20do%20NOT%0A%20%20%20%20need%20to%20modify%20your%20code%20at%20all%3A%0A%0A%20%20%20%20-%20your%20estimator%20inherits%20from%20%3Aclass%3A%60~base.BaseEstimator%60%0A%20%20%20%20-%20the%20parameters%20consumed%20by%20your%20estimator's%20methods%2C%20e.g.%20%60%60fit%60%60%2C%20are%0A%20%20%20%20%20%20explicitly%20defined%20in%20the%20method's%20signature%2C%20as%20opposed%20to%20being%0A%20%20%20%20%20%20%60%60*args%60%60%20or%20%60%60*kwargs%60%60.%0A%20%20%20%20-%20your%20estimator%20does%20not%20route%20any%20metadata%20to%20the%20underlying%20objects%2C%20i.e.%0A%20%20%20%20%20%20it's%20not%20a%20*router*.%0A%0A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20return%20(mo%2C)%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "notebook.py",
            "mode": "edit",
            "version": "0.17.0",
            "serverToken": "unused",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "below", "code_editor_font_size": 14, "custom_css": [], "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "columns", "reference_highlighting": true, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "uv"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "compact"},
            "view": {"showAppCode": false},
            "notebook": null,
            "session": null,
            "runtimeConfig": null,
        };
    </script>
  </body>
</html>
